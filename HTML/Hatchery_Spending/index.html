<html lang="en">
<head>
    <title>BPA Hatchery Spending and Performance</title>

    <meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="/script/dc.js/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/script/dc.js/dc.css"/>
	<script src="/script/jquery-1.12.2.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script src="https://d3js.org/queue.v1.min.js"></script>
	<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="/script/jquery.jsonview.min.js"></script>
	<!--<script src="//d3js.org/topojson.v1.min.js"></script>-->
	<script type="text/javascript" src="/script/dc.js/colorbrewer.js"></script>
	<link rel="stylesheet" type="text/css" href="/script/dc.js/ColorBrewerCSS.css"/>
	<script type="text/javascript" src="/script/crossfilter.min.js"></script>
	<script type="text/javascript" src="/script/dc.js/dc.js.2.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.css">

	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.21/b-1.6.2/b-html5-1.6.2/datatables.min.css"/>
 
	<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.21/b-1.6.2/b-html5-1.6.2/datatables.min.js"></script>

	<!--
	<script type="text/javascript" src="SitesBasins.js"></script>
	<script type="text/javascript" src="CrossTrack4c.js"></script>
	-->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
  integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
  crossorigin=""/>
  <!--<link rel="stylesheet" href="/script/dvf.css" type="text/css" media="screen"/>-->
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
  integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
  crossorigin=""></script>
  
  <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css"></link>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css"></link>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/1.4.0/regression.min.js"></script>

  <!--<script type="text/javascript" src="/script/leaflet-dvf.js"></script>-->
  <script type="text/javascript" src="map_utils2.js"></script>
  
  
<style>

.reds-0{fill: #fee5d9;stroke: #800;background: #fee5d9;border-color: #800;}
.reds-1{fill: #fcbba1;stroke: #800;background: #fcbba1;border-color: #800;}
.reds-2{fill: #fc9272;stroke: #800;background: #fc9272;border-color: #800;}
.reds-3{fill: #fb6a4a;stroke: #800;background: #fb6a4a;border-color: #800;}
.reds-4{fill: #de2d26;stroke: #800;background: #de2d26;border-color: #800;}
.reds-5{fill: #a50f15;stroke: #800;background: #a50f15;border-color: #800;}

.blues-0{fill: #eff3ff;stroke: #800;background: #eff3ff;border-color: #800;}
.blues-1{fill: #c6dbef;stroke: #800;background: #c6dbef;border-color: #800;}
.blues-2{fill: #9ecae1;stroke: #800;background: #9ecae1;border-color: #800;}
.blues-3{fill: #6baed6;stroke: #800;background: #6baed6;border-color: #800;}
.blues-4{fill: #3182bd;stroke: #800;background: #3182bd;border-color: #800;}
.blues-5{fill: #08519c;stroke: #800;background: #08519c;border-color: #800;}

.greens-0{fill: #edf8e9;stroke: #800;background: #edf8e9;border-color: #800;}
.greens-1{fill: #c7e9c0;stroke: #800;background: #c7e9c0;border-color: #800;}
.greens-2{fill: #a1d99b;stroke: #800;background: #a1d99b;border-color: #800;}
.greens-3{fill: #74c476;stroke: #800;background: #74c476;border-color: #800;}
.greens-4{fill: #31a354;stroke: #800;background: #31a354;border-color: #800;}
.greens-5{fill: #006d2c;stroke: #800;background: #006d2c;border-color: #800;}

.oranges-0{fill: #feedde;stroke: #800;background: #feedde;border-color: #800;}
.oranges-1{fill: #fdd0a2;stroke: #800;background: #fdd0a2;border-color: #800;}
.oranges-2{fill: #fdae6b;stroke: #800;background: #fdae6b;border-color: #800;}
.oranges-3{fill: #fd8d3c;stroke: #800;background: #fd8d3c;border-color: #800;}
.oranges-4{fill: #e6550d;stroke: #800;background: #e6550d;border-color: #800;}
.oranges-5{fill: #a63603;stroke: #800;background: #a63603;border-color: #800;}

.ylorbr-0{fill: #ffffd4;stroke: #800;background: #ffffd4;border-color: #800;}
.ylorbr-1{fill: #fee391;stroke: #800;background: #fee391;border-color: #800;}
.ylorbr-2{fill: #fec44f;stroke: #800;background: #fec44f;border-color: #800;}
.ylorbr-3{fill: #fe9929;stroke: #800;background: #fe9929;border-color: #800;}
.ylorbr-4{fill: #d95f0e;stroke: #800;background: #d95f0e;border-color: #800;}
.ylorbr-5{fill: #993404;stroke: #800;background: #993404;border-color: #800;}
	
.popuptable{
	font-size: 12;
}

.metric_select{
	width: 520px
}

#chart-year .x.axis text {
	text-anchor: end !important;;
	transform: rotate(-45deg);
	font-size: 12;
}

.axis_text{
	cursor: pointer;
}	
	
#filters > ul > li.active > a {
	padding-left: 6px;
	padding.right: 6px;
}

.leaflet-popup-content { width:500px; }	
img.leaflet-tile{
	pointer-events: none;
}
.action_marker{
	pointer-events: all;
	cursor: pointer;
}	
#leafmap{
	width: 800px;
	height: 700px;	
}	
.dataicon{
	width: 200px;
	height: 200px;	
}

.damicon i{
	width: 6px;
	height: 6px;
	float: left;
	margin-right: 5px;
}	

.control {margin:5px;}
#datarow {
	height: 300px;
	overflow: scroll;
}

.datatable.th {
		padding: 0
		margin: 0
}

#spinner * { 
	filter: none; 
	-moz-opacity: 100%; 
	position: absolute;
	top: 200px;
	left: 650px;
}
	
div.tooltip {   
  position: absolute;           
  text-align: left;                            
  padding: 2px;             
  font: 16px sans-serif;        
  background: #fff;   
  border: 0px;      
  border-radius: 8px;           
  pointer-events: none;         
}

svg	{ overflow: hidden; }
	
	table {
	margin: 10px;
	padding-top: 2px;
    padding-right: 10px;
    padding-bottom: 2px;
    padding-left: 10px;
	}
	
.dc-table-label {
font-weight: bold;
}

.header th {
text-align: center;	
}

.tiptable {
	font: 12px sans-serif;
}

.axis path, .axis line {
    fill: none;
    shape-rendering: crispedges;
    stroke: #000000;
}
.grid .tick {
    stroke: grey;
    opacity: 0.5 !important;
}
.bar rect {
        fill: #ed1e79;
    }

    .bar text.value {
        fill: black;
    }
    circle {
    fill: none;
    stroke: black; 
    stroke-width: 1;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

text {
  cursor: default;
}

path.line:hover{
	stroke-width: 2px;
}

.background path {
  fill: none;
  stroke: #ddd;
  shape-rendering: crispEdges;
}

.foreground path {
  fill: none;
  stroke: steelblue;
}

.brush .extent {
  fill-opacity: .3;
  stroke: #fff;
  shape-rendering: crispEdges;
}

.axis line,
.axis path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
  cursor: move;
}

input[type=range],
	::-moz-range-track,
	 ::-ms-track {
	 -webkit-appearance: none;
	 background-color: 3f91e5;
	 width: 400px;
	 height:40px;
}

input.vertical {
	-webkit-appearance: slider-vertical;
	writing-mode: bt-lr;
}
	</style>
</head>
<body>
<div class="container-fluid">
<div class="row">
<div class="span16">
<h2>BPA Hatchery Spending and Performance</h2>
<span>Spending on Selected: $<span id="filtered_amount"></span></span>&nbsp;
<a href="javascript:resetAll();">(reset all)</a></span>
</div>
</div>
<div class="row">
<div class="span5">
  <ul class="nav nav-tabs">
	<li class="active"><a data-toggle="tab" href="#filter1">Who/When</a></li>
    <li><a data-toggle="tab" href="#filter2">Why</a></li>
	<li><a data-toggle="tab" href="#filter3">What</a></li>
	<li><a data-toggle="tab" href="#filter4">Where</a></li>
	<li><a data-toggle="tab" href="#filter5">Options</a></li>
  </ul>

<div class="tab-content" style="height: 700">

    <div id="filter1" class="tab-pane fade in active">
		<div id="year" class="control">
			<div><strong>FY Started</strong>
				<a class="reset" href="javascript:year.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>

		<div id="progress" class="control">
			<div><strong>WSE Progress</strong>
				<a class="reset" href="javascript:progress.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>		
		
		<div id="contractor_type" class="control">
			<div><strong>Contractor Type</strong>
				<a class="reset" href="javascript:contractor_type.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		
		<div id="contractor" class="control">
			<div><strong>Contractor</strong>
				<a class="reset" href="javascript:contractor.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>		
	</div>
	
    <div id="filter2" class="tab-pane fade">
		<div id="emphasis" class="control">
			<div><strong>Emphasis</strong>
				<a class="reset" href="javascript:emphasis.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		<div id="purpose" class="control">
			<div><strong>Purpose</strong>
				<a class="reset" href="javascript:purpose.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		<div id="project" class="control">
			<div><strong>Project</strong>
				<a class="reset" href="javascript:project.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>	


		<div id="area1" class="control">
			<div><strong>Primary Hatchery Purpose</strong>
				<a class="reset" href="javascript:area1.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		
		<div id="area2" class="control">
			<div><strong>Secondary Hatchery Purpose</strong>
				<a class="reset" href="javascript:area2.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>		

		<div id="species1" class="control">
			<div><strong>Primary Focal Species</strong>
				<a class="reset" href="javascript:species1.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		
		<div id="species2" class="control">
			<div><strong>Secondary Focal Species</strong>
				<a class="reset" href="javascript:species2.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>		
	</div>
	
	<div id="wecategory" class="control">
		<div><strong>Work Element Category</strong>
			<a class="reset" href="javascript:wecategory.filterAll(); redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	
    <div id="filter3" class="tab-pane fade">
		<div id="welement" class="control">
			<div><strong>Work Element</strong>
				<a class="reset" href="javascript:welement.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		
		
	
		<div id="metric" class="control">
			<div><strong>Metric</strong>
				<a class="reset" href="javascript:metric.filterAll(); redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
	
		
	</div>
    <div id="filter4" class="tab-pane fade">
	
	<div id="huc3name" class="control">
		<div><strong>Basin</strong>
		<a class="reset" href="javascript:huc3name.filterAll(); redrawAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	
	<div id="huc4name" class="control">
		<div><strong>Subbasin</strong>
		<a class="reset" href="javascript:huc4name.filterAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	<div id="huc5name" class="control">
		<div><strong>Watershed</strong>
		<a class="reset" href="javascript:huc5name.filterAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	<div id="huc6name" class="control">
		<div><strong>Subwatershed</strong>
		<a class="reset" href="javascript:huc6name.filterAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>	
	
	<div id="species" class="control">
		<div><strong>Species</strong>
		<a class="reset" href="javascript:species.filterAll(); redrawAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	
	<div id="esu" class="control">
		<div><strong>ESU/DPS</strong>
		<a class="reset" href="javascript:esu.filterAll(); redrawAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	
	<div id="mpg" class="control">
		<div><strong>MPG</strong>
		<a class="reset" href="javascript:mpg.filterAll(); redrawAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	
	<div id="population" class="control">
		<div><strong>Population</strong>
		<a class="reset" href="javascript:population.filterAll(); redrawAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>	

	<div id="hassites" class="control">
		<div><strong>Has Sites?</strong>
		<a class="reset" href="javascript:hassites.filterAll(); redrawAll();redrawAll();" style="display: none;">reset</a>
		</div>
	</div>	

	</div>
	<div id="filter5" class="tab-pane fade">
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">Summed Variable</th></tr>
		<tr><td align="left" colspan=2><input type="radio" name="accessorvar" value="sum" checked onclick="params.accessorvar='sum';dc.redrawAll()"></input>&nbsp;<span class="dropdown_text">Budgeted</span></td></tr>
		<tr><td align="left"colspan=2><input type="radio" name="accessorvar" value="ovhd" onclick="params.accessorvar='ovhd';dc.redrawAll()"></input>&nbsp;<span class="dropdown_text">Overhead</span></td></tr>
		<tr><td align="left"colspan=2><input type="radio" name="accessorvar" value="sumplus" onclick="params.accessorvar='sumplus';dc.redrawAll()"></input>&nbsp;<span class="dropdown_text">Budgeted+Overhead</span></td></tr>
		</table>

		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">Site Marker Size</th></tr>
		<tr><td align="left" colspan="2"><input id="sitesize_slider" type = "range" min ="1" max="100" step ="1" value ="25"/></tr>
		<tr><th align="left" class="dropdown_text">Site Marker Color</th><td><input id="site_colorpicker"></input></td></tr>
		</td></tr>
		</table>		
<!--		
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">Pie Size/Color Set</th></tr>
		<tr><td align="left"><input id="piesize_slider" type = "range" min ="1" max="100" step ="1" value ="25"/></tr>
		<tr><td align="left">
		<select id="pie_palette" onchange="togglePiePalette(this)"></select>
		</td></tr>
		</table>
-->		
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">HUC Style</th></tr>
		<!--<tr><td align="left" colspan=2><input type="radio" name="hucstyle" value="1" checked onclick="params.HUC.style='valuefill';"></input>&nbsp;<span class="dropdown_text">Filled by Mean Value</span></td></tr>-->
		<tr><td align="left"colspan=2><input type="radio" name="hucstyle" value="2" checked onclick="params.HUC.style='uniformfill';"></input>&nbsp;<span class="dropdown_text">Uniform Fill</span></td></tr>
		<tr><td align="left"colspan=2><input type="radio" name="hucstyle" value="3" onclick="params.HUC.style='outline';"></input>&nbsp;<span class="dropdown_text">Outline Only</span></td></tr>
		<tr><th align="left" class="dropdown_text">HUC Border Color</th><td><input id="hucborder_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">HUC Fill Color</th><td><input id="hucback_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">HUC Fill Opacity</th>
		<td align="left"><input id="hucback_slider" type = "range" min ="0" max="100" step ="2" value ="50"/></td></tr>		
		<tr><th align="left" class="dropdown_text">HUC Label Color</th><td><input id="huclabel_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">Label Font Size</th>
		<td align="left"><input id="huclabel_slider" type = "range" min ="14" max="32" step ="2" value ="24"/></td></tr>
		<tr><th align="left" class="dropdown_text">HUC Label Width</th>
		<td align="left"><input id="huclabelwidth_slider" type = "range" min ="60" max="400" step ="20" value ="200"/></td></tr>		
		</table>
		<br>
		<table cellpadding="3">
		<tr><th align="left" class="dropdown_text">Pop Border Color</th><td><input id="pop_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">Pop Fill Color</th><td><input id="popfill_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">Pop Fill Opacity</th>
		<td align="left"><input id="popback_slider" type = "range" min ="0" max="100" step ="2" value ="50"/></td></tr>			
		<tr><th align="left" class="dropdown_text">Pop Label Color</th><td><input id="poplabel_colorpicker"></input></td></tr>
		<tr><th align="left" class="dropdown_text">Label Font Size</th>
		<td align="left"><input id="poplabel_slider" type = "range" min ="16" max="48" step ="2" value ="28"/></td></tr>
		<tr><th align="left" class="dropdown_text">Pop Label Width</th>
		<td align="left"><input id="poplabelwidth_slider" type = "range" min ="60" max="400" step ="20" value ="200"/></td></tr>		
		</table>		

		<table><tr><th align="left" class="dropdown_text">Map Width</th>
			<td><input id="mapwidth_slider" type = "range" min ="200" max="1200" step ="10" value ="800"/></td>
			</tr>
		<tr><th align="left" class="dropdown_text">Map Height</th>
			<td><input id="mapheight_slider" type = "range" min ="200" max="1000" step ="10" value ="600"/></td>
		</tr></table>
	</div>	
</div>	
</div>

<div class="span14">

  <ul class="nav nav-tabs">
	<li class="active"><a data-toggle="tab" href="#filter20">Spending</a></li> 
	<li><a data-toggle="tab" href="#filter22">Metrics</a></li>
<!--	
    <li><a data-toggle="tab" href="#filter10">Map</a></li>
	<li><a data-toggle="tab" href="#filter25">CombiFilter</a></li>
-->	
	<li><a data-toggle="tab" href="#filter30">Data Table</a></li>	
  </ul>

<div class="tab-content">
<div id="filter10" class="tab-pane fade">
	<div id="leafmap">
	Initializing Map...
	</div>
</div>

<div id="filter20" class="tab-pane fade in active">
	<table width="950"><tr><td width="350"><b>Variable:</b> <select id="chart_yvar" onChange = "params.chart.current.yvar = this.options[this.selectedIndex].value; doChart()"/></td><td><b>Fill Color:</b> <select id="chart_stackvar" onChange = "params.chart.current.stackvar = this.options[this.selectedIndex].value; doChart()"/></td>
	<td>&nbsp;&nbsp;&nbsp;<input type="checkbox" onChange="toggleRowLabel(this)">&nbsp;<b>Show Row Sum</b></input></td>
	<td align="right" width="50"><image src="download.png" height="20" width = "20" id="chart_csv_download"/></td></tr>
	</table>
	<div id="rowchart">
	</div>
</div>
<div id="filter22" class="tab-pane fade">
	<table width="950"><tr><td width="350"><b>Variable:</b> <select id="chart_yvar2" onChange = "params.chart.current.yvar2 = this.options[this.selectedIndex].value; doChart2()"/></td><td><b>Fill Color:</b> <select id="chart_stackvar2" onChange = "params.chart.current.stackvar2 = this.options[this.selectedIndex].value; doChart2()"/></td>
	<td>&nbsp;&nbsp;&nbsp;<input type="checkbox" onChange="toggleRowLabel(this)">&nbsp;<b>Show Row Sum</b></input></td>
	<td align="right" width="50"><image src="download.png" height="20" width = "20" id="chart_csv_download2"/></td></tr>
	<tr><td colspan="3"><b>Metric:</b> <select class="metric_select" id="chart_metric" onChange = "params.chart.current.metricvar = this.options[this.selectedIndex].value; doChart2()"/></td></tr>
	</table>
	<div id="rowchart2">
	</div>
</div>
<div id="filter25" class="tab-pane fade">
	<p style="width: 600px">Two or more Filter Sets (combinations of filters in the left panel) can be combined via a "logical OR" to create a new filter which enables the selection of all
	data rows which satisfy all the criteria of at least one of the included Filter Sets. Set at least one filter to get started.
	</p>
	<table id="filters_table" width="600" border="1" cellpadding="5">
	<tr id="filter_row">
	<td id="current_filters">
	</td>
	</tr></table>
	<div id="combi" class="control">
	</div>
</div>
<div id="filter30" class="tab-pane fade">
	<div>
	<a class="toggle-vis" data-column="0">Project#</a> |
	<a class="toggle-vis" data-column="1">Project</a> |
	<a class="toggle-vis" data-column="2">Contractor</a> |
	<a class="toggle-vis" data-column="3">Contract#</a> |
	<a class="toggle-vis" data-column="4">Year</a> |
	<a class="toggle-vis" data-column="5">WE ID</a> |
	<a class="toggle-vis" data-column="6">WE Name</a> |	
	<a class="toggle-vis" data-column="7">WSE ID</a> |
	<a class="toggle-vis" data-column="8">WSE Title</a> |
	<a class="toggle-vis" data-column="9">Protocol</a> |
	<a class="toggle-vis" data-column="10">Protocol URL</a> |
	<a class="toggle-vis" data-column="11">WSE Budget</a> |
	<a class="toggle-vis" data-column="12">Overhead</a>	|
	<a class="toggle-vis" data-column="13">Total</a>	|
	<!--&nbsp;&nbsp;<image src="download.png" height="20" width = "20" id="csv_download"/>-->
	<span id="tablebuttons"></span>
	</div>
	<br/>
	<br/>
	<div style="scroll: auto;height: 700px">
	<table id="data-table" class="display" width="1200"></table>
	</div>
</div>
</div>
</div>
</div>
<!--
<div class="row">
<div class="span16">
	  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Showing 100 (or less)</b>
      <table class='table table-hover' id='datatable'>
        <thead>
          <tr class='header'>
            <th>Primary RM&E Type</th>
			<th>Primary Focal Area</th>			
            <th>Work Statement Element</th>
            <th>Amount</th>
          </tr>
        </thead>
      </table>
</div>

</div>
-->
</div>

<div id="spinner"><img src="/images/spinner.gif"></div>
</body>

<script>
var tipdiv = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

$("#site_colorpicker").spectrum({
    color: "#e58f3e",
	hide: function(tinycolor) {
		params.Site.color = "#" + tinycolor.toHex();
		d3.selectAll(".site_marker").style("fill",params.Site.color)		
	},
});	
	
$("#hucborder_colorpicker").spectrum({
    color: "#fff",
	hide: function(tinycolor) {
		params.HUC.bordercolor = "#" + tinycolor.toHex();
	},
});

$("#huclabel_colorpicker").spectrum({
    color: "#000",
	hide: function(tinycolor) {
		params.HUC.labelcolor = "#" + tinycolor.toHex();
		d3.selectAll(".huclabeltable").style("color",params.HUC.labelcolor)
	},
});

$("#hucback_colorpicker").spectrum({
    color: "#ccc",
	hide: function(tinycolor) {
		params.HUC.color = "#" + tinycolor.toHex();
	},
});

$("#poplabel_colorpicker").spectrum({
    color: "#000",
	hide: function(tinycolor) {
		params.population.labelcolor = "#" + tinycolor.toHex();
		d3.selectAll(".poplabeltable").style("color",params.population.labelcolor)
	},
});	

$("#popfill_colorpicker").spectrum({
    color: "orange",
	hide: function(tinycolor) {
		params.population.color = "#" + tinycolor.toHex();
	},
});

$("#pop_colorpicker").spectrum({
    color: "white",
	hide: function(tinycolor) {
		params.population.bordercolor = "#" + tinycolor.toHex();
	},
});

$("#sitesize_slider").on("input", function(){
	params.Site.size = +this.value;
	doWorkSites()
});

$("#piesize_slider").on("input", function(){
	params.pie.sliderscale = +this.value/25;
	doPies();
});

$("#huclabel_slider").on("input", function(){
	params.HUC.labelsize = +this.value;
	d3.selectAll(".huclabeltable td").style("font-size",params.HUC.labelsize)
});	

$("#hucback_slider").on("input", function(){
	params.HUC.opacity = +this.value/100;
});

$("#poplabel_slider").on("input", function(){
	params.population.labelsize = +this.value;
	d3.selectAll(".poplabeltable td").style("font-size",params.population.labelsize)
});

$("#huclabelwidth_slider").on("input", function(){
	params.HUC.labelwidth = +this.value;
	d3.selectAll(".huclabeltable").style("width",params.HUC.labelwidth)
});

$("#poplabelwidth_slider").on("input", function(){
	params.population.labelwidth = +this.value;
	d3.selectAll(".poplabeltable").style("width",params.population.labelwidth)
});

$("#popback_slider").on("input", function(){
	params.population.opacity = +this.value/100;
});

$("#mapwidth_slider").on("input", function(){
	d3.select("#leafmap").style("width",+this.value)
});	

$("#mapheight_slider").on("input", function(){
	d3.select("#leafmap").style("height",+this.value)
});	

function toggleRowLabel(checkbox){
	if(checkbox.checked){
		d3.selectAll(".valuelabels").style("visibility","visible")
		params.chart.showrowsum=true
	}
	else{
		d3.selectAll(".valuelabels").style("visibility","hidden")
		params.chart.showrowsum=false
	}
}

var ndx;

var params = {
	filtersets: [],
	accessorvar: "sum",
	accessorfxns: {
		sum: function(d){return d.value.sum},
		ovhd: function(d){return d.value.ovhd},
		sumplus: function(d){return d.value.sumplus}
	},
	circle_size:{
		scale: 1, 
		metric: "mean_count",
		statistic: "mean",
		fxn: "log10"
	},
	population: {
		labelwidth: 200,
		labelsize: 24,
		labelcolor: "#000000",
		color: "orange",
		opacity: .5,
		bordercolor: "#ffffff"
	},
	pie: {
		colors:
		{
			ylorbr: {label: "Yl-Or-Br", palette: colorbrewer.YlOrBr[6]},
			reds: {label: "Reds", palette: colorbrewer.Reds[6]},
			blues: {label: "Blues", palette: colorbrewer.Blues[6]},
			oranges: {label: "Oranges", palette: colorbrewer.Oranges[6]},
			greens: {label: "Greens", palette: colorbrewer.Greens[6]},
		},
		selectedcolor: "ylorbr",
		scale: 10,
		rmax: 30,
		display: false,
		sliderscale: 1,
		palette: "Blues",
		colorlevels: 6,
		palette_invert: true,
		scale:
		{
			HUC3: [5000,10000,15000,20000,25000],
			HUC4: [1000,2000,3000,4000,5000],
			HUC5: [100,250,500,750,1000],
			HUC6: [25,50,100,150,200]
		}
	},
	HUC: {
		LabelLayer: null,
		style: "uniformfill",
		labelwidth: 200,
		labelsize: 24,
		labelcolor: "#000000",
		color: "#ccc",
		opacity: .5,
		bordercolor: "#ffffff"
	},
	RME: {
		breaks: d3.scale.threshold().domain([2.5,5,10,20,40]).range(["0-2.5","2.5-5","5-10","10-20","20-40",">40"]),
		segment_length: .25,//stream segment length in km
		aggregation_level: "HUC3",
		variable: "count",
		domain: ["0-2.5","2.5-5","5-10","10-20","20-40",">40"],
		range: ["0-2.5","2.5-5","5-10","10-20","20-40",">40"],
		size: "Count"
	},
	Site:{
		size: 25,
		color: "#e58f3e"
	}
}


var basins = {
"170101": {name: "Kootenai", latitude: 48.5, longitude: -115.5235},
"170102": {name: "Pend Oreille", latitude: 48, longitude: -114.9479},
"170103": {name: "Spokane", latitude: 47.75, longitude: -115.4},
"170200": {name: "Upper Columbia", latitude: 47.95625, longitude: -120.1890},
"170300": {name: "Yakima", latitude: 46.66245, longitude: -120.6642},
"170401": {name: "Snake Headwaters", latitude: 44, longitude: -116},
"170402": {name: "Upper Snake", latitude: 44, longitude: -117},
"170501": {name: "Middle Snake-Boise", latitude: 44.73, longitude: -118},
"170502": {name: "Middle Snake-Powder", latitude: 44.73, longitude: -117.45},
"170601": {name: "Lower Snake", latitude: 45.75422, longitude: -117.4659},
"170602": {name: "Salmon", latitude: 44.93850, longitude: -114.9479},
"170603": {name: "Clearwater", latitude: 46.19148, longitude: -115.5235},
"170701": {name: "Middle Columbia", latitude: 45.87265, longitude: -119.7252},
"170702": {name: "John Day", latitude: 44.81256, longitude: -119.4764},
"170703": {name: "Deschutes", latitude: 44.79145, longitude: -121.1090},
"170800": {name: "Lower Columbia", latitude: 46.09247, longitude: -122.2330},
"170900": {name: "Willamette", latitude: 44.81256, longitude: -122.2330},
"171001": {name: "Washington Coastal", latitude: 47.16125356933019, longitude: -123.79375847993488},
"171002": {name: "Northern Oregon Coastal",latitude: 44.89154584809262, longitude: -123.83205145901715},
"171003": {name: "Southern Oregon Coastal",latitude: 42.79432543115027, longitude: -123.5379571311292},
"171200": {name: "Oregon Closed Basins (Malheur)",latitude: 42.8, longitude: -119.5},
"171100": {name: "Puget Sound", latitude: 47.75, longitude: -122.23} 
}


params.pops = {
	"0":{
		POPID: 0,
		ESU: "NA",
		MPG: "NA",
		PopName: "Unassigned"
	}
}
populations.forEach(function(d){
	params.pops[d[0]] = {
		POPID: d[0],
		ESU: d[5],
		MPG: d[6],
		PopName: (d[3].split("-")[0].trim())
	}
})



var redrawAll = function(){
	dc.redrawAll();
}

var togglePiePalette = function(_select){
	console.log(_select)
	var palettes = params.pie.colors
	params.pie.selectedcolor = _select.value;
	density.ordinalColors(palettes[params.pie.selectedcolor].palette)
	density.redraw()
	doPies();
	doChart();
	doChart2();
}

var buildPieColorPicker = function(target){
d3.select("#"+target)
  .selectAll(".palette")
    .data(d3.entries(params.pie.colors))
  .enter().append("option")
    .attr("class", "palette")
	.property("value",function(d) { 
        return d.key;
	})
	.text(function(d) { 
        return d.value.label;
	})
}

buildPieColorPicker("pie_palette");


/*
var species = dc.rowChart("#chart-species");
var population = dc.pieChart("#chart-pop");
var huc3name = dc.rowChart("#chart-huc3name");
var huc4name = dc.pieChart("#chart-huc4name");
var huc5name = dc.pieChart("#chart-huc5name");
var huc6name = dc.pieChart("#chart-huc6name");

*/
queue()
	.defer(d3.csv,"HUC_Names_Centroids.csv")
	.defer(d3.csv,"RME_Pops.csv")
	.defer(d3.csv,"Hatchery_Spending_Sites_05-06-2021.csv")
	.defer(d3.csv,"Hatchery_Spending_Metrics_05-06-2021.csv")
	.defer(d3.csv,"Hatchery_Spending_WSE_05-06-2021.csv")
	//.await(doPage)
	.await(processFiles)

var utilDim;
//var datatable = dc.dataTable("#datatable");	
var contractor = dc.rowChart("#contractor");
var contractor_type = dc.rowChart("#contractor_type");
var year = dc.rowChart("#year");
var progress = dc.rowChart("#progress");
var emphasis = dc.rowChart("#emphasis");
var purpose = dc.rowChart("#purpose");
//var wecategory = dc.rowChart("#wecategory");
var welement = dc.rowChart("#welement");
//var wsetitle = dc.pieChart("#wsetitle");
var area1 = dc.rowChart("#area1");
var area2 = dc.rowChart("#area2");
var type1 = dc.rowChart("#type1");
var type2 = dc.rowChart("#type2");

var focus1 = dc.pieChart("#focus1");
var focus2 = dc.rowChart("#focus2");
var metric = dc.pieChart("#metric");


var species1 = dc.rowChart("#species1");
var species2 = dc.rowChart("#species2");
var project = dc.pieChart("#project");

var population = dc.pieChart("#population");
//var run = dc.pieChart("#run");
var mpg = dc.pieChart("#mpg");
var esu = dc.pieChart("#esu");
var species = dc.pieChart("#species");

var huc3name = dc.pieChart("#huc3name");
var huc4name = dc.pieChart("#huc4name");
var huc5name = dc.pieChart("#huc5name");
var huc6name = dc.pieChart("#huc6name");

var hassites = dc.pieChart("#hassites");

var filtered_amount = dc.numberDisplay('#filtered_amount');

var combi;

year._chartname = "FY Started"
contractor_type._chartname = "Contractor Type"
contractor._chartname = "Contractor"
emphasis._chartname = "Emphasis"
purpose._chartname = "Purpose"
project._chartname = "Project"
type1._chartname = "Primary RM&E Type"
type2._chartname = "Secondary RM&E Type"
area1._chartname = "Primary RM&E Focal Area"
area2._chartname = "Secondary RM&E Focal Area"
species1._chartname = "Primary RM&E Species"
species2._chartname = "Secondary RM&E Species"
welement._chartname = "Work Element"
//wecategory._chartname = "Work Element Category"
focus1._chartname = "Metric Focus 1"
focus2._chartname = "Metric Focus 2"
species._chartname = "Species"
esu._chartname = "ESU/DPS"
mpg._chartname = "MPG"
progress._chartname = "WSE Progress"
population._chartname = "Population"
hassites._chartname = "Has Sites?"

huc3name._chartname = "Basin";
huc4name._chartname = "Subbasin";
huc5name._chartname = "Watershed";
huc6name._chartname = "Subwatershed";

params.chart = {
		yvar: {
			Contractor: {variable: "Contractor"},
			"Contractor Type": {variable: "Contractor_Type"},
			"Emphasis": {variable: "Emphasis"},
			"Purpose": {variable: "Purpose"},
			"Work Element": {variable: "WE_Name"},
			"Primary Hatchery Purpose": {variable: "WSE_Purpose1", chart: area1},
			"Secondary Hatchery Purpose": {variable: "WSE_Purpose2", chart: area2},					
		},
		stackvar:{
			Contractor: {variable: "Contractor", chart: contractor},
			"Contractor Type": {variable: "Contractor_Type", chart: contractor_type},
			"Emphasis": {variable: "Emphasis", chart: emphasis},
			"Purpose": {variable: "Purpose", chart: purpose},
			"Work Element": {variable: "WE_Name", chart: welement},
			"Primary Hatchery Purpose": {variable: "WSE_Purpose1", chart: area1},
			"Secondary Hatchery Purpose": {variable: "WSE_Purpose2", chart: area2},
			"FY Started": {variable: "FY_Started", chart: year},			
		},
		metricvar:
		[
			"# juveniles you released to the natural environment during this contract period",
			"# of female fish retained as broodstock",
			"# of male fish retained as broodstock",
			"# of juveniles retained in your facility at the end of this contract period",
			"# eggs you released to the natural environment during this contract period",
			"# of kelts collected or received",
			"# of juveniles imported from a BPA-funded facility",
			"# of juveniles imported from a non BPA-funded facility",
			"# eggs imported from a non BPA-funded facility",
			"# eggs transferred to another BPA-funded facility",
			"# of eggs retained in your facility at the end of this contract period",
			"# of juveniles transferred to another BPA-funded facility",
			"# of adults retained in your facility at the end of this contract period",
			"# eggs imported from a BPA-funded facility",
			"# of captively reared adults retained in your facility at the end of this contract period",
			"# of kelts transferred to a BPA-funded facility",
			"# of adults imported from a non BPA-funded facility",
			"# of adults imported from a BPA-funded facility",
			"# of adults transferred to another BPA-funded facility",
			"# of captively reared adults transferred to a BPA-funded facility",
			"# of adults released to the natural environment during this contract period",
			"# eggs transferred to a non BPA-funded facility",
			"# of captively reared adults released to the natural environment during this contract period",
			"# of adults transferred to a non BPA-funded facility",
			"# adult fish released to non-anadromous fishery",
			"# eggs received from a non-BPA program",
			"# juveniles transferred to a non BPA-funded facility",
			"Total weight of fish stocked in kilograms",
			"# of fish stocked",
			"# of kelts released to natural environment during this contract period",
			"# of captively reared adults transferred to a non BPA-funded facility"
		],
		current: {
			yvar: "Contractor",
			stackvar: "Work Element",
			yvar2: "Contractor",
			stackvar2: "Work Element",
			metricvar: "# juveniles you released to the natural environment during this contract period"			
		},
		showrowsum: false
	};
	
var buildChartSelect = function(type,target){
d3.select("#"+target)
  .selectAll(".chartvar")
    .data(Object.keys(params.chart[type]))
  .enter().append("option")
    .attr("class", "chartvar")
	.property("value",function(d) { 
        return d;
	})
	.property("selected",function(d){
		if(params.chart.current[type] == d)return true
		else return false
	})
	.text(function(d) { 
        return d;
	})
}

var buildMetricSelect = function(){
d3.select("#chart_metric")
  .selectAll(".chartvar2")
    .data(params.chart["metricvar"])
  .enter().append("option")
    .attr("class", "chartvar2")
	.property("value",function(d) { 
        return d;
	})
	.property("selected",function(d){
		if(params.chart.current["metricvar"] == d)return true
		else return false
	})
	.text(function(d) { 
        return d;
	})
}

buildChartSelect("yvar","chart_yvar");	
buildChartSelect("stackvar","chart_stackvar");
buildChartSelect("yvar","chart_yvar2");	
buildChartSelect("stackvar","chart_stackvar2")
buildMetricSelect();

function processFiles(error,huc_names,pops,sites,metrics,data){
	//console.log(huc_names)
	//console.log(pops)
	//console.log(locs)
	//console.log(sites)
	
	params.nosites = []
	params.contracts = {}
	params.wse = {}	
	
	data.forEach(function(d){
		d.Contractor = d.Contractor.split(" (")[0]
		d.Purpose = d.Purpose == "" ? "None Specified" : d.Purpose;
		d.Emphasis = d.Purpose == "" ? "None Specified" : d.Emphasis;
		d.Type1 = d.Type1 == "" ? "None Specified" : d.Type1;
		d.Type2 = d.Type2 == "" ? "None Specified" : d.Type2;
		d.Area1 = d.Area1 == "" ? "None Specified" : d.Area1;
		d.Area2 = d.Area2 == "" ? "None Specified" : d.Area2;		
		d.Budget_Frac = +d.Budget_Frac;
		d.Current = +d.Current
		d.Final = +d.Final;
		d.Invoiced = +d.Invoiced;
		d.Overhead = +d.Overhead < 0 ? 0 : +d.Overhead;
		d.Overhead_Frac = +d.Overhead_Frac < 0 ? 0 : +d.Overhead_Frac;
		d.WSE_Budget = +d.WSE_Budget;
		d.Total = d.WSE_Budget + d.Overhead
		d.WE_Name = d.WE_Name + ": " + d.WE_ID
		d.Species1 = d.Species1.split(",")
		d.Species2 = d.Species2.split(",")
		d.Overhead = 0
		d.Overhead_Frac = 0
		d.WSE_Actual = +d.WSE_Actual
		d.WSE_Planned = +d.WSE_Planned
		d.Sites = []
		d.sites = {}
		d.Metrics = []
		d.metric = {}
		d.Pops = []
		params.wse[d.WSE_ID] = d
		
		if(!params.contracts[d.Contract_Number])params.contracts[d.Contract_Number] = 
			{
			Contract_Number: d.Contract_Number,
			WSE_Budget_Unlocated: 0,
			Overhead_Unlocated: 0,
			Count_Located: 0,
			Current: +d.Current,
			Final: +d.Final,
			Invoiced: +d.Invoiced
			}
	})
	
	metrics.forEach(function(d){
		//"WSE_ID","Metric_ID","Metric","Planned","Actual"
		var wse = params.wse[d.WSE_ID];
		if(wse){
			d.Planned = +d.Planned
			d.Actual = +d.Actual
			wse.Metrics.push(d)
			wse.metric[d.Metric]=d
		}
	})
	
	function addHUCLocation(big,small){
		big.Latitude = (+big.Latitude*big.n + +small.Latitude)/(big.n + 1)
		big.Longitude = (+big.Longitude*big.n + +small.Longitude)/(big.n + 1)
		big.n++
		return big
	}	
	
	params.huc_lookup = {}
	params.huc_locations = {}
	huc_names.forEach(function(d){
		params.huc_lookup[d.HUC12] = {level: "HUC6", name: d.HUC_12_NAME};
		params.huc_lookup[d.HUC10] = {level: "HUC5", name: d.HUC_10_NAME};
		params.huc_lookup[d.HUC8] = {level: "HUC4", name: d.HUC_8_NAME};
		params.huc_locations[d.HUC12] = {Latitude: +d.Latitude, Longitude: +d.Longitude, n: 1}
		if(!params.huc_locations[d.HUC10])params.huc_locations[d.HUC10] = {Latitude: +d.Latitude, Longitude: +d.Longitude, n: 1}
		else params.huc_locations[d.HUC10] = addHUCLocation(params.huc_locations[d.HUC10],d)
		if(!params.huc_locations[d.HUC8])params.huc_locations[d.HUC8] = {Latitude: +d.Latitude, Longitude: +d.Longitude, n: 1}
		else params.huc_locations[d.HUC8] = addHUCLocation(params.huc_locations[d.HUC8],d)		
	});
	
	Object.keys(basins).forEach(function(d){
		params.huc_lookup[d] = {level: "HUC3", name: basins[d].name}
		params.huc_locations[d] = {Latitude: basins[d].latitude, Longitude: basins[d].longitude, n: 1}
	})
	
	params.pops = {}
	
	pops.forEach(function(d){
		params.pops[d.POPID] = d;
		if(d.ESU_DPS == "")d.ESU_DPS = "NA"
	})	
	
	sites.forEach(function(d){
//"Site_ID","WSE_ID","HUC_12","Descriptio","Latitude","Longitude","Pops"
		if(params.wse[d.WSE_ID]){
		d.HUC6 = d.HUC_12.toString()
		if(d.HUC_12 != "NA"){
			d.HUC5 = d.HUC_12.substring(0,10)
			d.HUC4 = d.HUC_12.substring(0,8) 
			d.HUC3 = d.HUC_12.substring(0,6)
			
			d.HUC6name = params.huc_lookup[d.HUC6].name
			d.HUC5name = params.huc_lookup[d.HUC5].name
			d.HUC4name = params.huc_lookup[d.HUC4].name	
			if(!params.huc_lookup[d.HUC3])console.log(d)			
			d.HUC3name = params.huc_lookup[d.HUC3].name
		}
		else{
			d.HUC5 = "NA";
			d.HUC4 = "NA"; 
			d.HUC3 = "NA";
			d.HUC6name = "NA";
			d.HUC5name = "NA";
			d.HUC4name = "NA";
			d.HUC3name = "NA";	
		}

		params.wse[d.WSE_ID].Sites.push(d)
		}
	})
	
	Object.keys(params.wse).forEach(function(id){
		var wse = params.wse[id]
		wse.Pops = {}
		wse.Sites.forEach(function(site){
			if(!site)console.log(wse)
			var pops = []
			site.Pops.split(",").forEach(function(pop){
			if(params.pops[pop.toString()])wse.Pops[pop.POPID] = params.pops[pop.toString()]
			})
		})
		
		//var pops = []
		//wse.Pops = pops
		wse.PopName = [], wse.MPG = [], wse.Run = [], wse.ESU = [], wse.Species = [];
		wse.HUC3 = [], wse.HUC4 = [], wse.HUC5 = [], wse.HUC6 = [];
		wse.HUC3name = [], wse.HUC4name = [], wse.HUC5name = [], wse.HUC6name = [];
		
		Object.keys(wse.Pops).forEach(function(d){
			//console.log(wse.Pops[d])
			wse.PopName.push(wse.Pops[d].POPID + "-" + wse.Pops[d].POPULATIONNAME.split(" - ")[0])
			wse.MPG.push(wse.Pops[d].MAJORPOPGROUP)
			wse.Run.push(wse.Pops[d].RUN)
			wse.ESU.push(wse.Pops[d].ESU_DPS)
			wse.Species.push(wse.Pops[d].SPECIES)
		})	
	})	
	
		params.data = data;
		doPage()
		
}	
	
function doPage(){

	//params.data = data
	ndx = crossfilter(params.data);
	const all = ndx.groupAll();

	
	var getHUC = function(sites,name){
		if(sites.length==0)return ["NA"];
		else{
			var s = []
			sites.forEach(function(site){
				s.push(site[name])
			})
			return s;
		}
	}
	var getPop = function(pops,name){
		if(pops.length==0)return ["NA"];
		else{
			var p = []
			pops.forEach(function(pop){
				p.push(pops[name])
			})
			return p;
		}
	}	

	var huc3nameDim = ndx.dimension(function(d) {return getHUC(d.Sites,"HUC3name");},true);
	var huc4nameDim = ndx.dimension(function(d) {return getHUC(d.Sites,"HUC4name");},true);
	var huc5nameDim = ndx.dimension(function(d) {return getHUC(d.Sites,"HUC5name");},true);
	var huc6nameDim = ndx.dimension(function(d) {return getHUC(d.Sites,"HUC6name");},true);
	var contractorDim = ndx.dimension(function(d) {return d.Contractor;});
	var contractor_typeDim = ndx.dimension(function(d) {return d.Contractor_Type;});
	var yearDim = ndx.dimension(function(d) {return d.FY_Started;});
	var progressDim = ndx.dimension(function(d) {return d.Progress;});
	var emphasisDim = ndx.dimension(function(d) {return d.Emphasis;});
	var purposeDim = ndx.dimension(function(d) {return d.Purpose;});
	var projectDim = ndx.dimension(function(d) {return d.Project_Title;});
	var welementDim = ndx.dimension(function(d) {return d.WE_Name;});
//	var wsetitleDim = ndx.dimension(function(d) {return d.WSE_Title;});
	var area1Dim = ndx.dimension(function(d) {return d.WSE_Purpose1;});
	var area2Dim = ndx.dimension(function(d) {return d.WSE_Purpose2;});
	var type1Dim = ndx.dimension(function(d) {return d.Type1;});
	var type2Dim = ndx.dimension(function(d) {return d.Type2;});
	var species1Dim = ndx.dimension(function(d) {return d.Species1;},true);
	var species2Dim = ndx.dimension(function(d) {return d.Species2;},true);
	var metricDim = ndx.dimension(function(d) {
		var metrics = [];
		d.Metrics.forEach(function(m){
			metrics.push(m.Metric)
		})
		return metrics;},true);
	var focus1Dim = ndx.dimension(function(d) {return "NA";});
	var focus2Dim = ndx.dimension(function(d) {return "NA";});
	var speciesDim = ndx.dimension(function(d) {return d.Species;},true);
	var esuDim = ndx.dimension(function(d) {return d.ESU;},true);
	var mpgDim = ndx.dimension(function(d) {return d.MPG;},true);
	var populationDim = ndx.dimension(function(d) {return d.PopName;},true);	
	//utilDim = ndx.dimension(function(d) {return d.WSE_ID;});
	utilDim = ndx.dimension(function(d) {return d.Total;});
	var hassitesDim = ndx.dimension(function(d) {return d.Sites.length > 0;});
	var haspopsDim = ndx.dimension(function(d) {return d.Pops.length > 0;});
	var metricsDim = ndx.dimension(function(d) {return Object.keys(d.metric);},true);
	var metricsGroup = metricsDim.group()
	params.mtest=metricsGroup
	
	var amountGroup = ndx.groupAll().reduce(
		function (p, v) {
			p.sum += v.WSE_Budget;
			p.ovhd += Math.round(v.Overhead);
			p.sumplus += v.WSE_Budget + Math.round(v.Overhead);
			return p;
		},

		function (p, v) {
			p.sum -= v.WSE_Budget;
			p.ovhd -= Math.round(v.Overhead);
			p.sumplus -= v.WSE_Budget + Math.round(v.Overhead);
			return p;
		},

		function () {
			return {
				sum: 0,
				ovhd: 0,
				sumplus: 0
			};
		}
	);

	filtered_amount.group(amountGroup).valueAccessor(function(d) {
      return d[params.accessorvar];
	});	
	
	contractor
    .width(325)
    .height(1200)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(contractorDim)
	.elasticX(true)
    .group(getGroup(contractorDim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)

	contractor.ordering(function(d) { return -d.value[params.accessorvar] })
	
	contractor
	.on('postRedraw',function(){
		document.getElementById("spinner").style.visibility = 'visible';
		params.sliders.forEach(function(d){addSlider(d)});
		if(params.leafmap)doWorkSites()
		doChart()
		doChart2()
		if(params.table){
			writeDataTable()
			setColumnHide()
		}	
		combiFilter()
		document.getElementById("spinner").style.visibility = 'hidden';
	});
	
	console.log("Contractor")
	
	contractor_type
    .width(325)
    .height(250)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(contractor_typeDim)
	.elasticX(true)
    .group(getGroup(contractor_typeDim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)

	contractor_type.ordering(function(d) { return -d.value[params.accessorvar] })

year
    .width(325)
    .height(250)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(yearDim)
	.elasticX(true)
    .group(getGroup(yearDim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)
	
progress
    .width(325)
    .height(175)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(progressDim)
	.elasticX(true)
    .group(getGroup(progressDim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)

hassites
    .width(325)
    .height(150)
    .radius(70)
	.cx(70)
	.cy(80)	
    .dimension(hassitesDim)
    .group(getGroup(hassitesDim))
	.legend(dc.legend().x(150).y(10).itemHeight(13).gap(5))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})	
	
	emphasis
    .width(325)
    .height(250)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(emphasisDim)
	.elasticX(true)
    .group(getGroup(emphasisDim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)
	
	emphasis.ordering(function(d) { return -d.value[params.accessorvar] })
	
	purpose
    .width(325)
    .height(200)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(purposeDim)
	.elasticX(true)
    .group(getGroup(purposeDim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	purpose.ordering(function(d) { return -d.value[params.accessorvar] })

	welement
    .width(325)
    .height(250)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(welementDim)
	.elasticX(true)
    .group(getGroup(welementDim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	welement.ordering(function(d) { return -d.value[params.accessorvar] })

	area1
    .width(325)
    .height(225)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(area1Dim)
	.elasticX(true)
    .group(getGroup(area1Dim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	area1.ordering(function(d) { return -d.value[params.accessorvar] })	
	
	area2
    .width(325)
    .height(225)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(area2Dim)
	.elasticX(true)
    .group(getGroup(area2Dim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	area2.ordering(function(d) { return -d.value[params.accessorvar] })

	type1
    .width(325)
    .height(200)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(type1Dim)
	.elasticX(true)
    .group(getGroup(type1Dim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	type1.ordering(function(d) { return -d.value[params.accessorvar] })	
	
	type2
    .width(325)
    .height(200)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(type2Dim)
	.elasticX(true)
    .group(getGroup(type2Dim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	type2.ordering(function(d) { return -d.value[params.accessorvar] })	
	
	species1
    .width(325)
    .height(700)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(species1Dim)
	.elasticX(true)
    .group(getGroup(species1Dim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	species1.ordering(function(d) { return -d.value[params.accessorvar] })	

	species2
    .width(325)
    .height(700)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(species2Dim)
	.elasticX(true)
    .group(getGroup(species2Dim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	species2.ordering(function(d) {  return -d.value[params.accessorvar] })	

	setChart(metric,metricDim,325,250,70,80,true)
    metric
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})
	
	setChart(focus1,focus1Dim,325,250,70,80,true)
	focus1
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})

	focus2
    .width(325)
    .height(150)
	.margins({top: 0, left: 5, right: 5, bottom: 40})
    .dimension(focus2Dim)
	.elasticX(true)
    .group(getGroup(focus2Dim))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
	.transitionDuration(100)	

	focus2.ordering(function(d) {  return -d.value[params.accessorvar] })	
	
	setChart(project,projectDim,325,250,70,80,true)
	
	project
		.data(function(group) {
		return group.all().filter(function(kv) {
			return kv.value.sum>0; 
		});
	})
	
    species
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})	
	.width(325)
    .height(150)
    .radius(70)
	.cx(70)
	.cy(80)	
    .dimension(speciesDim)
    .group(getGroup(speciesDim))
	.legend(dc.legend().x(150).y(10).itemHeight(13).gap(5))
	.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})

	
	setChart(esu,esuDim,325,250,70,80,true)
    esu
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})

	setChart(mpg,mpgDim,325,250,70,80,true)
    mpg
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})	

	
	setChart(population,populationDim,325,250,70,80,true)
    population
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})
	
	setChart(huc3name,huc3nameDim,325,200,70,80,true)
    huc3name
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})	
	console.log("huc3")
	
	setChart(huc4name,huc4nameDim,325,200,70,80,true)
    huc4name
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})	
	console.log("huc4")

	setChart(huc5name,huc5nameDim,325,200,70,80,true)
    huc5name
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})	
	console.log("huc5")

	setChart(huc6name,huc6nameDim,325,200,70,80,true)
    huc6name
	.data(function(group) {
      return group.all().filter(function(kv) {
	  return kv.value.sum > 0; 
	  });
	})	
	console.log("huc6")		

	dc.renderAll();
	params.sliders = [project,metric,esu,mpg,population,focus1,huc3name,huc4name,huc5name,huc6name]
	params.sliders.forEach(function(d){addSlider(d)});	

	doChart()
	doChart2()
	
	setFilterToggle(contractor,"contractor")
	setFilterToggle( contractor_type,"contractor_type");
	setFilterToggle( year,"year");
	setFilterToggle( emphasis,"emphasis");
	setFilterToggle( purpose,"purpose");
	setFilterToggle( welement,"welement");
	setFilterToggle( area1,"area1");
	setFilterToggle( area2,"area2");
	setFilterToggle( type1,"type1");
	setFilterToggle( type2,"type2");
	setFilterToggle( focus1,"focus1");
	setFilterToggle( focus2,"focus2");
	setFilterToggle( metric,"metric");
	setFilterToggle( species1,"species1");
	setFilterToggle( species2,"species2");
	setFilterToggle( project ,"project");
	setFilterToggle( population,"population");
	setFilterToggle( mpg,"mpg");
	setFilterToggle( esu,"esu");
	setFilterToggle( species,"species");
	setFilterToggle( huc3name,"huc3name");
	setFilterToggle( huc4name,"huc4name");
	setFilterToggle( huc5name,"huc5name");
	setFilterToggle( huc6name,"huc6name");
	setFilterToggle( hassites,"hassites");
	
	d3.selectAll(".dc-chart g.row text").style("fill","black");
	

	

	//doPies();
	//addFDATLayer();
	//params.HUC.LabelLayer = L.featureGroup().addTo(params.leafmap);
	document.getElementById("spinner").style.visibility = 'hidden';
}

  d3.select("#filter10").on("transitionend", function(d) {
  console.log("loaded")
  if(!params.leafmap){
	addMap();
	params.leafmap.setView([45.93,-117.53], 7);
	L.control.legend({ position: 'bottomleft', id: "pie_legend" }).addTo(params.leafmap);
	//addStates();
	//addDams();
	//addLayerGroups();
	addHUCLayer()
	params.HUC.LabelLayer = L.featureGroup().addTo(params.leafmap);
	addPopBoundaries("styleChinook")
	addPopBoundaries("styleSteelhead")
	params.poplabelgroup = L.featureGroup().addTo(params.leafmap);	
	addRivers();
	params.RiverLayer.addTo(params.leafmap)		
	doWorkSites()
	params.currentHUC = hucvar(params.leafmap._zoom)

	params.leafmap.on('zoomend',function(e){
		var huc = hucvar(params.leafmap._zoom);
		if(huc != params.currentHUC){
			if(params.HUC.LabelLayer)params.HUC.LabelLayer.clearLayers();
			if(params.poplabelgroup)params.poplabelgroup.clearLayers();
		}
	})
	params.leafmap.on("moveend", function () {
		//doChart();
	});	
	}
});

  d3.select("#filter30").on("transitionend", function(d) {
	console.log("loaded")
	if(!params.table){
		writeDataTable()
	}
});



function setColumnHide(){
	$('a.toggle-vis').on( 'click', function (e) {
        e.preventDefault();
 
        // Get the column API object
        var column = params.table.column( $(this).attr('data-column') );
 
        // Toggle the visibility
        column.visible( ! column.visible() );
    } );
}

function writeDataTable(){
	var rows = []
	var csvdata = []; 
	var items = ["Project_Number","Project_Title","Contractor","Contract_Number","FY_Started","WE_ID","WE_Name","WSE_ID","WSE_Title","Protocol_Name","Protocol_URL","WSE_Budget","Overhead","Total"]
	//csvdata.push(items)	used for csv export
	utilDim.top(Infinity).forEach(function(d){
		var row = [];
		items.forEach(function(item){row.push(d[item].toString())})
		rows.push(row)
		//csvdata.push(row); used for csv export
	})
	//d3.select("#data-table").html("")
	if(params.table)params.table.destroy();
	params.table = $('#data-table').DataTable( {
        data: rows,
		buttons: [
        'csvHtml5'
		],
		//"scrollY": 700,
        "scrollX": true,
        columns: [
			{ title: "ProjectID", visible: false," searchable": false},
			{ title: "Project" },
            { title: "Contractor", visible: false},
			{ title: 
				"Contract#", 
				"searchable": false,
				"render": function(data, type, row, meta)
				 {
					if(type === 'display'){
						data = '<a href="https://www.cbfish.org/Contract.mvc/Summary/' + encodeURI(data) + '" target="_new">' + data + '</a>';
					}

					return data;
				 }
			},
            { title: "Year", "searchable": false },
            { title: "WE ID", visible: false,
				"searchable": false,
				"render": function(data, type, row, meta)
				 {
					if(type === 'display'){
						data = '<a href="https://www.cbfish.org/WorkElement.mvc/Summary/' + encodeURI(data) + '" target="_new">' + data + '</a>';
					}

					return data;
				 }			
			},
            { title: "WE Name", visible: false },			
            { title: "WSE ID", visible: false,
			"searchable": false,
				"render": function(data, type, row, meta)
				 {
					if(type === 'display'){
						data = '<a href="https://www.cbfish.org/WorkStatementElement.mvc/Summary/' + encodeURI(data) + '" target="_new">' + data + '</a>';
					}

					return data;
				 }			
			},
            { title: "WSE Title" },
			{ title: "Protocol", visible: false },
			{ title: "Protocol URL",
			 visible: false,
			 searchable: false,
			 "render": function(data, type, row, meta)
				 {
					if(type === 'display'){
						data = '<a href="' + data + '" target="_new">' + data + '</a>';
					}

					return data;
				 }
			},			
			{ 
				title: "WSE Budget($)",
				render: $.fn.dataTable.render.number( ',', '.', 2, '$' ),
				visible: false,
				"searchable": false
			},
			{ 
				title: "Overhead($)",
				render: $.fn.dataTable.render.number( ',', '.', 2, '$' ),
				visible: false,
				"searchable": false
			},
			{ 
				title: "Total($)",
				render: $.fn.dataTable.render.number( ',', '.', 2, '$' ),
				visible: true,
				"searchable": false
			}			
        ]
    } );
	params.table.buttons().container()
    .appendTo( $('#tablebuttons', params.table.table().container() ) );
	setColumnHide()
	
	//set download button
		d3.select("#csv_download")
		  .style("cursor","pointer")
		  .on("mouseover", function(d) {
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 1);      
				tipdiv.html("Download Chart CSV")  
					.style("left", (d3.event.pageX + 20) + "px")     
					.style("top", (d3.event.pageY - 10) + "px");    
			})                  
		  .on("mouseout", function(d) {       
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 0);   
			})
		  .on("click", function(d){	
				console.log(csvdata)
				var filename = "RME_Data.csv"
				writeCSV(csvdata,filename)
			})	
}

function doWorkSites(){
	if(!params.SiteLayer){
		params.SiteLayer = L.featureGroup().addTo(params.leafmap);
		params.layerControl.addOverlay(params.SiteLayer, "Work Sites")
	}
	params.SiteLayer.clearLayers();

	var sites = {}
	var locdata = []
	
	utilDim.top(Infinity).filter(function(d){
		return d.Sites.length>0
	})
	.forEach(function(wse){
		wse.Sites.forEach(function(site){
			if(!sites[site.ID])sites[site.ID] = {site: site, wselements: [wse]}
			else sites[site.ID].wselements.push(wse)
		})
	})
	
	params.sitearray = [];//this is for aggregation by HUC
	
	Object.keys(sites).filter(function(d){
		return sites[d].wselements.length > 0
	})
	.forEach(function(d){
		var site = sites[d]
		site.WSE_Budget = 0;
		site.Overhead = 0
		site.wselements.forEach(function(wse){
			
			site.WSE_Budget += wse.WSE_Budget/(wse.WSE.Sites.length)
			site.Overhead += wse.Overhead/(wse.WSE.Sites.length)
		})
		
		params.sitearray.push(site);
		
		var rvalue = params.accessorvar == "ovhd" ? site.Overhead : (params.accessorvar == "sumplus" ? site.WSE_Budget + site.Overhead : site.WSE_Budget)
		var radius = 2 + 4*rvalue/100000
		
		var circle = new L.circleMarker([site.site.Latitude, site.site.Longitude],{
		className: "site_marker",
		radius: radius*params.Site.size/100,
		stroke: true,
		color: 'black',
		opacity: 1,
		weight: 1,
		fill: true,
		fillColor: params.Site.color,
		fillOpacity: .8
		});
		//console.log(site.WSE_Budget)
		var nested_data = d3.nest() 
			.key(function(d) { return d.Project_Number + ": " + d.Project_Title; })
			.key(function(d) { return d.FY_Started; })
			.key(function(d) { return d.Contract_Number + ": " + d.Contractor; })
			.key(function(d) { return d.WSE_Title; })
			.entries(site.wselements, d3.map)			
		
		var currency = d3.format('$,.0f')
		
		var html = '<table cellpadding="5"><tr><th align="left">Site</th><td aligh="left">';
		html += site.site.ID + ": " + site.site.Descriptio + '</td></tr>';
		html += '<tr><th align="left">WSE_Budget</th><td aligh="left">'
		html += currency(Math.round(site.WSE_Budget).toString()) + '</td></tr>';
		html += '<tr><th align="left">Overhead</th><td aligh="left">'
		html += currency(Math.round(site.Overhead).toString()) + '</td></tr>';
		var popup = L.popup({maxWidth: 300, className: "circlepopup"}).setContent(html);
		//.setContent('<pre>' + JSON.stringify(d, null, ' ') + '</pre>')
		circle.bindPopup(popup)
		params.SiteLayer.addLayer(circle)
		circle.on("popupopen",function(){
			console.log(nested_data)
			//$("#siteinfo").JSONView(nested_data,{ collapsed: false });
		})
	})
	sumHUC();
}

function sumHUC(){
	var hucvar = d3.scale.threshold().domain([6.5,7.5,8.5]).range([3,4,5,6])
	console.log("HUC"+hucvar(params.leafmap._zoom))
	var nested_data = d3.nest()
	.key(function(d) { return d.site["HUC"+hucvar(params.leafmap._zoom)]; })
	.rollup(function(sites) { return {"nsites": sites.length, "WSE_Budget": d3.sum(sites, function(d) {return d.WSE_Budget;}),"Overhead": d3.sum(sites, function(d) {return d.Overhead;})} })
	.entries(params.sitearray);
	params.hucsums = nested_data;
}

function combiFilter(){
	getFilterList = function(){
	params.currentfilters = [];
	var list = dc.chartRegistry.list();
	for (var i = 0; i < list.length; i++) {
		var chart = list[i];
		for (var j = 0; j < chart.filters().length; j++){
			params.currentfilters.push({ChartName: chart._chartname, ChartID: chart.chartID(), Filter: chart.filters()[j]});  
		}
	}

	if(params.currentfilters.length==0)return "";

	var reftext = "<table cellpadding='3'><tr>";
	for(i=0;i<params.currentfilters.length;i++)reftext += "<th align='left' valign='top'>" + params.currentfilters[i].ChartName + "</th><td align='left'>" + params.currentfilters[i].Filter + "</td></tr>";
	reftext += '<tr id="addFilterButton"><td align="right" colspan="2"><a onclick="addCurrentFilters()" style="cursor: pointer;"><b>Add Filter Set &#x25B6;</b></a>'
	reftext += "</table>";
	return reftext;
	}
	
	var current_filters = document.getElementById("current_filters");
	current_filters.innerHTML = getFilterList();
}

function addCurrentFilters(){
	params.filtersets.push({filters: params.currentfilters, wse: utilDim.top(Infinity)})
	d3.select("#filter_row").append("td").html(d3.select("#current_filters").html())
	d3.selectAll("#addFilterButton").remove()
	if(params.filtersets.length>1){
		var newrow = d3.select("#filters_table").append("tr")
		newrow.attr("id","combineFiltersButton")
		newrow.html('<td/><td align="center" colspan="' + params.currentfilters.length*2 + '"><a onclick="combineFilterSets()" style="cursor: pointer;"><b>Generate Combi Filter &#x25BC;</b></a>')
	}
}

function combineFilterSets(){
	if(params.filtersets.length > 0){
		params.combifilter = {}
		params.filtersets.forEach(function(set){
			set.wse.forEach(function(d){
				params.combifilter[d.WSE_ID] = true;
			})
		})
		combi = dc.pieChart("#combi");
		var dim = ndx.dimension(function(d) {if(params.combifilter[d.WSE_ID]) return true; else return false});
		combi	
		.width(325)
		.height(150)
		.radius(70)
		.cx(70)
		.cy(80)	
		.dimension(dim)
		.group(getGroup(dim))
		.legend(dc.legend().x(150).y(10).itemHeight(13).gap(5))
		.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]})	
		combi._chartname = "Union of Filter Sets"
		dc.filterAll()
		combi.render();
		combi.filter(true)
		dc.redrawAll()
		
		d3.select("#combi").append("div").attr("id","deleteCombiButton").html('<a onclick="clearCombiFilter()" style="cursor: pointer;"><b>Clear Combi Filter</b></a>')
	}
}

function clearCombiFilter(){
	combi.filterAll()
	//combi.dimension() = null
	d3.select("#combi").select("svg").remove();
	//combi = null;
	params.filtersets = []
	d3.select("#filter_row").selectAll("td").html("")
	d3.select("#combineFiltersButton").remove()
	dc.redrawAll()
	d3.select("#deleteCombiButton").remove()
}


function getChartColors(chart){
//gets the range and domain for the chart specified
	var domain = []
	chart.data().forEach(function(d){
	  domain.push(d.key)
	})
	var range = []
	chart.svg()
	.selectAll(".row")
	.select("rect")
	.each(function(){
	   range.push(d3.select(this).attr("fill"))
	})

	var colorscale = d3.scale.ordinal().domain(domain).range(range)
	return colorscale
}
//function getChart

class StackedRowChart{
	constructor(options){
		if (!options.data || !options.target || !options.colorscale) {
			console.log(options)
			return null;
		}
		console.log("creating")
		this.data = options.data
		this.target = options.target
		this.colorscale = options.colorscale
		this.margins = options.margins?options.margins:{top: 5, bottom: 60, left: 360, right: 35}
		var height = options.height?options.height:800
		this.height = height-this.margins.top-this.margins.bottom
		var width = options.width?options.width:1000
		this.width = width-this.margins.left-this.margins.right
		this.svg = d3.select("#" + this.target)
			.append("svg")
			.attr("height",height)
			.attr("width",width)
		this.svg
		.append("g")
			.attr("class", "main")
			.attr("transform", "translate(" + this.margins.left + "," + this.margins.top + ")");
			
		this.valueAccessor = function(d){ return (d.WSE_Budget + d.Overhead)/1000000}		
	}
	
	initBarData(yvariable,stackvariable){
		this.yvar = yvariable
		this.stackvar = stackvariable
		var _this = this;
		var valueAccessor = this.valueAccessor
		this.bardata = d3.nest()
		.key(function(d) {return d[yvariable]})
		.key(function(d) {return d[stackvariable]})
		.entries(this.data)
		
		//set sum for each 
		this.bardata.forEach(function(yvar){
			//sort by indexed stack variable
			yvar.values.sort(function(a,b){
				var domain = _this.colorscale.domain()
				return domain.indexOf(a.key) - domain.indexOf(b.key)
			})
			//get sum and offset for each
			var offset = 0;			
			yvar.values.forEach(function(stackvar){
				stackvar.yvar = yvar
				stackvar.offset = offset;
				stackvar.sum = d3.sum(stackvar.values,valueAccessor);
				offset += stackvar.sum;
			})
			//get total for yvar			
			yvar.sum = d3.sum(yvar.values,function(d){
				return d.sum;
			})

		})
		this.globalmax = d3.max(this.bardata,function(d){return d.sum })
		this.bar_height = .75*this.height/(this.bardata.length+1)
		
		this.bardata.sort(function(a,b){
			return b.sum-a.sum
		})
		
		return this;
	}
	
	getBarColor(d){
		return this.colorscale(d.key)
	}
	
	getBarArray(){
		var data = []
		this.bardata.forEach(function(yvar){
			yvar.values.forEach(function(stackvar){
				data.push(stackvar)
			})
		})
		return data
	}
	
	setYScale(){
		var domain = []
		this.bardata.forEach(function(d){
			domain.push(d.key)
		})
		this.yscale = d3.scale.ordinal().domain(domain).rangeBands([0, this.height],1)
		return this;
	}
	
	setYAxis(){
		var textscale = d3.scale.threshold().domain([20,35,50]).range(["13px","14px","15px","16px"])
		var yAxis = d3.svg.axis().scale(this.yscale).orient("left");
		this.svg
			.select("g.main")
			.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 6)
			.attr("dy", ".71em")
			.style("text-anchor", "end");
		this.svg
			.select(".y.axis")
			.selectAll("g.tick")
			.style("font-size",textscale(this.bar_height));
		return this;			
		return this;	
	}
	
	setYLabel(label){
	
		function dragmovelabel(d) {
		var g = d3.select(this)
		.attr("transform", function(d) { return "translate(" + d3.event.x + "," + d3.event.y + ")"})
		}
		
		var draglabel = d3.behavior.drag().on("drag", dragmovelabel);	
	
		var axisLabelX = 15;
		var axisLabelY = this.height/2;
		this.svg	
		.append('g')
			.attr('transform', 'translate(' + axisLabelX + ', ' + axisLabelY + ')')
			.call(draglabel)
			.append('text')
			.attr('text-anchor', 'middle')
			.attr('transform', 'rotate(-90)')
			.text(label)
			.style("font-size","18px")
			.style("font-weight","bold")			
		return this;
	}	
	
	setXScale(){
		this.xscale = d3.scale.linear().domain([0,this.globalmax]).range([0, this.width])
		return this;
	}
	
	setXLabel(label){
	
		var axisLabelX = this.margins.left + this.width/2;
		var axisLabelY = this.margins.top + this.margins.bottom + this.height - 15;
		this.svg	
		.append('g')
			.attr('transform', 'translate(' + axisLabelX + ', ' + axisLabelY + ')')
			.append('text')
			.attr('text-anchor', 'middle')
			.text(label)
			.style("font-size","18px")
			.style("font-weight","bold")			
		return this;
	}	
	
	setXAxis(){
		var xAxis = d3.svg.axis().scale(this.xscale).orient("bottom")//.tickFormat(d3.format("d"));
		this.svg
			.select("g.main")
			.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + this.height + ")")
			.call(xAxis);
		this.svg
			.select(".x.axis")
			.selectAll("g.tick")
			.style("font-size","16px");
		return this;	
	}
	
	doBars(){
		var formatDecimal = d3.format(".2f");
		var _this = this;
		this.svg
			.select(".main")
			.append("g")
			.attr("class","stackedbars")
			.selectAll("rect")
			.data(this.getBarArray())
			.enter()
			.append("rect")
			.attr("class","bar")
			.attr("x",function(d){
				return _this.xscale(d.offset)
			})
			.attr("y",function(d){
				return _this.yscale(d.yvar.key) - _this.bar_height/2
			})
			.attr("width",function(d){
				return _this.xscale(d.sum)
			})			
			.attr("height",_this.bar_height)
			.style("fill",function(d){
				return _this.colorscale(d.key)
			})
			
		var textscale = d3.scale.threshold().domain([10,20,30,40,50]).range(["12px","13px","14px","15px","16px","18px"])	
		
		var labels = this.svg
						.select(".main")
						.append("g")
						.attr("class","valuelabels")
						.style("visibility", params.chart.showrowsum ? "visible" : "hidden")
		this.bardata.forEach(function(d){
			var LabelX = _this.xscale(d.sum) + 1;
			var LabelY = _this.yscale(d.key) + _this.bar_height/3;
			labels	
			.append('g')
				.attr('transform', 'translate(' + LabelX + ', ' + LabelY + ')')
				.append('text')
				.attr('text-anchor', 'left')
				.text(formatDecimal(d.sum))
				.style("font-size",textscale(_this.bar_height))			
		})				
		return this	
	}
	
	addMouseOver(){
		function getHTML(d){
			var formatDecimal = d3.format(".2f");
			var formatFraction = d3.format(".0f");
			var html = '<table width="300" cellpadding="3" cellspacing="3" border="1"><tr><th valign="top" align="left">';
			html += params.chart.current.yvar;
			html += '</th><td valign="top" align="left">';
			html += d.yvar.key;
			html += '</td></tr><tr><th valign="top" align="left">';
			html += params.chart.current.stackvar;
			html += '</th><td valign="top" align="left">';
			html += d.key;
			html += '</td></tr><tr><th valign="top" align="left">Value</th><td valign="top" align="left">'
			html += "$" + formatDecimal(d.sum) + " million (" + formatFraction(100*d.sum/d.yvar.sum) + "%)";			
			html += '</td></tr></table>'
			return html
		}
		var _this = this
		this.svg
		.selectAll("rect.bar")
		.on("mouseover", function(d) {
			tipdiv.transition()        
			.duration(20)      
			.style("opacity", 1);      
			tipdiv.html(getHTML(d))
			.style("width",320)
			.style("left", (d3.event.pageX + 5) + "px")     
			.style("top", (d3.event.pageY +10) + "px");
		})                  
		.on("mouseout", function() {       
		tipdiv.transition()        
			.duration(20)      
			.style("opacity", 0);
		});
		return this
	}
	
	doLegend(stackchart,label){
	
		function dragmovelegend(d) {
		var g = d3.select(this)
		.attr("transform", function(d) { return "translate(" + d3.event.x + "," + d3.event.y + ")"})
		}
		
		var draglegend = d3.behavior.drag().on("drag", dragmovelegend);
	
		var legend = this.svg
		.append("g")
		.attr("class","legend")
		.attr("transform","translate(600,400)")
		.call(draglegend)
		
		legend.append("g")
			.attr("class","title")
			.append("text")
			.text(label)
			.style("font-size","14px")
			.style("font-weight","bold")
			
		legend.append("g")
			.attr("class","legend_rows")
			.attr("transform","translate(0,7)")
			.html(stackchart.svg().select("g").html())
		
		this.svg.select("g.legend").select("g.axis").remove()
		this.svg.select("g.legend").select("g.tick").remove()
		this.svg.select("g.legend").selectAll("g.row").select("rect").attr("width","10")
		this.trimLegend(stackchart);
		return this
	}
	
	trimLegend(stackchart){
		var legend = this.svg.select("g.legend")
		//get array of positions - don't currently need this
		/*
		var positions = [];
		legend.select(".legend_rows")
			.selectAll("g.row")
			.each(function(d){
				///positions.push(d.attr("transform"))
				positions.push(d3.select(this).attr("transform"))
			})
			console.log(positions);
		*/	
		var hasValue = []
		stackchart.data().forEach(function(d,i){
			if(d.value.sum>0)hasValue.push(true);
			else hasValue.push(false);
		})
		//console.log(hasValue);
		legend.select(".legend_rows")
			.selectAll("g.row")
			.style("visibility",function(d,i){
				return hasValue[i] ? "visible" : "hidden";
			})
	}
	
	setDownload(target){
		var _this = this
		var dataobj = {}
		
		this.yscale.domain().forEach(function(d){
			dataobj[d] = {}
			_this.colorscale.domain().forEach(function(dd){
				dataobj[d][dd] = 0
			})
		})
		
		this.bardata.forEach(function(yvar){
			yvar.values.forEach(function(d){
			  dataobj[yvar.key][d.key] = d.sum;
			})
		})
		
		var header = []
		var csvdata = []
		header.push(this.yvar)
		_this.colorscale.domain().forEach(function(d){
			header.push(d)
		})
		csvdata.push(header)
		
		this.yscale.domain().forEach(function(d){
			var newrow = [d]
			_this.colorscale.domain().forEach(function(dd){
				newrow.push(dataobj[d][dd])
			})
			csvdata.push(newrow)
		})		
		d3.select("#" + target)
		  .style("cursor","pointer")
		  .on("mouseover", function(d) {
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 1);      
				tipdiv.html("Download Chart CSV")  
					.style("left", (d3.event.pageX + 20) + "px")     
					.style("top", (d3.event.pageY - 10) + "px");    
			})                  
		  .on("mouseout", function(d) {       
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 0);   
			})
		  .on("click", function(d){	
				console.log(csvdata)
				var filename = _this.yvar + "-" + _this.stackvar + ".csv"
				writeCSV(csvdata,filename)
			})
		return this;
	}

}

class StackedBarTimeseriesChart{
	constructor(options){
		if (!options.data || !options.target) {
			console.log(options)
			return null;
		}
		console.log("creating")
		this.data = options.data
		this.target = options.target
		this.margins = options.margins?options.margins:{top: 0, bottom: 100, left: 350, right: 20}
		var height = options.height?options.height:800
		this.height = height-this.margins.top-this.margins.bottom
		var width = options.width?options.width:800
		this.width = width-this.margins.left-this.margins.right
		this.svg = d3.select("#" + this.target)
			.append("svg")
			.attr("height",height)
			.attr("width",width)
		this.svg
		.append("g")
			.attr("class", "main")
			.attr("transform", "translate(" + this.margins.left + "," + this.margins.top + ")");
			
		this.valueAccessor = function(d){ return d.WSE_Budget + d.Overhead}		
	}
	
	initBarData(x,y){
		var valueAccessor = this.valueAccessor
		this.bardata = d3.nest()
		.key(function(d) {return d[y]})
		.key(function(d) {return d[x]})
		.entries(this.data)
		
		//set sum for each year
		this.bardata.forEach(function(contractor){
			contractor.values.forEach(function(year){
				year.sum = d3.sum(year.values,valueAccessor)
			})
			contractor.max = d3.max(contractor.values,function(d){
				return d.sum
			})
		})
		this.globalmax = d3.max(this.bardata,function(d){return d.max })
		
		return this;
	}
	
	setYScale(){
		var domain = []
		this.bardata.forEach(function(d){
			domain.push(d.key)
		})
		this.yscale = d3.scale.ordinal().domain(domain).rangeBands([0, this.height],1)
		return this;
	}
	
	setYAxis(){
		var yAxis = d3.svg.axis().scale(this.yscale).orient("left");
		this.svg
			.select("g.main")
			.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 6)
			.attr("dy", ".71em")
			.style("text-anchor", "end");
			
		return this;	
	}
	
	setXScale(domain){
		this.xscale = d3.scale.linear().domain(domain).range([0, this.width])
		return this;
	}
	
	setXAxis(){
	var xAxis = d3.svg.axis().scale(this.xscale).orient("bottom").tickFormat(d3.format("d"));
		this.svg
			.select("g.main")
			.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + this.height + ")")
			.call(xAxis);
		return this;	
	}
}


function doChart(){
	d3.select("#rowchart").select("svg").remove()
	//var chart = new StackedBarTimeseriesChart({data:utilDim.top(Infinity),target:"rowchart"})
	//chart = new StackedRowChart({data:utilDim.top(Infinity),target:"rowchart",colorscale: getChartColors(welement)})
	chart = new StackedRowChart({
			data: utilDim.top(Infinity).sort(function(a,b){
				return (b.WSE_Budget + b.Overhead)-(a.WSE_Budget + a.Overhead)
			}),
			target: "rowchart",
			colorscale: getChartColors(params.chart.stackvar[params.chart.current.stackvar].chart)
		})
	chart
	//.initBarData("Contractor","WE_Name")
	.initBarData(params.chart.yvar[params.chart.current.yvar].variable,params.chart.stackvar[params.chart.current.stackvar].variable)
	.setYScale()
	.setYAxis()
	.setYLabel(params.chart.current.yvar)
	.setXScale()
	.setXAxis()
	.setXLabel("Sum WSE Budgets ($million)")
	.doBars()
	.addMouseOver()
	.doLegend(params.chart.stackvar[params.chart.current.stackvar].chart,params.chart.current.stackvar)
	.setDownload("chart_csv_download")
	
}

function doChart2(){
	d3.select("#rowchart2").select("svg").remove()

	var cdata = []
	utilDim.top(Infinity).forEach(function(d){
		var metrics = d.Metrics.filter(function(m){return m.Metric==params.chart.current.metricvar})
		if(metrics.length>0){
			var metric = metrics[0];
			var obj = {Actual: metric.Actual,Planned: metric.Planned}
			obj[params.chart.yvar[params.chart.current.yvar2].variable] = d[params.chart.yvar[params.chart.current.yvar2].variable]
			obj[params.chart.stackvar[params.chart.current.stackvar2].variable] = d[params.chart.stackvar[params.chart.current.stackvar2].variable]
			cdata.push(obj)
		}
	})
	
	chart = new StackedRowChart({
			data: cdata.sort(function(a,b){
				return b.Planned-a.Planned
			}),
			target: "rowchart2",
			colorscale: getChartColors(params.chart.stackvar[params.chart.current.stackvar2].chart)
		})
	chart.valueAccessor = function(d){ return d.Planned}
	chart
	//.initBarData("Contractor","WE_Name")
	.initBarData(params.chart.yvar[params.chart.current.yvar2].variable,params.chart.stackvar[params.chart.current.stackvar2].variable)
	.setYScale()
	.setYAxis()
	.setYLabel(params.chart.current.yvar2)
	.setXScale()
	.setXAxis()
	.setXLabel("Count")
	.doBars()
	.addMouseOver()
	.doLegend(params.chart.stackvar[params.chart.current.stackvar2].chart,params.chart.current.stackvar2)
	.setDownload("chart_csv_download2")
	
	console.log(cdata)
}


//var FDATcolorscale = d3.scale.ordinal().domain(params.RME.range).range(params.pie.colors[params.pie.selectedcolor].palette)


class ClusterPie{
	constructor(options){
		if (!options.data || !options.target) {
			console.log(options)
			return null;
		}
		console.log("creating pie")
		this.data = options.data;
		this.colorScale = options.colorScale;
		this.radiusScale = options.radiusScale;
	}
}


function doPies(){

	if(!params.PieLayer){
		params.PieLayer = L.featureGroup().addTo(params.leafmap);
		params.layerControl.addOverlay(params.PieLayer, "Site Summary Pies")
	}
	params.PieLayer.clearLayers();
	if(params.HUC.LabelLayer)params.HUC.LabelLayer.clearLayers();
	  let rmax = 30

	  var variable = params.RME.variable

	  
	  var nested_data = params.RME.rollup

	nested_data.forEach(function(d){
		d.location = params.huc_locations[d.key];
		d.name = params.huc_lookup[d.key].name
		var myIcon = getPieIcon(d)
		var pie = L.marker([d.location.Latitude,d.location.Longitude], {icon: myIcon})
		params.PieLayer.addLayer(pie)

		d3.select(".HUC" + d.key)
			.on("mouseover", function() {
				
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 1);      
				tipdiv.html(d.name)	
					.style("left", (d3.event.pageX + 5) + "px")     
					.style("top", (d3.event.pageY +10) + "px");
				})                  
			.on("mouseout", function() {       
				tipdiv.transition()        
					.duration(20)      
					.style("opacity", 0);
			})	
			.on("click",function(){
				addHUCLabel(d.key,d.name,d.location)
				d3.selectAll(".huclabel").style("font-size",params.HUC.labelsize)
				d3.selectAll(".huclabeltable").style("width",params.HUC.labelwidth)				
			})		
	})
	addPieLegend();
}

var addHUCLabel = function(id,name,location){
		var lat = location.Latitude;
		var lon = location.Longitude;
		var html, words;
		
		html = "<table class='huclabeltable'><tr><td align='left' class='huclabel'>" + name + "</td></tr></table>"
		
		var divIcon = L.divIcon({ 
		html: html,
		className: "huclabel",
		draggable: true,
		color: params.HUC.labelcolor
		})
		
		var marker = L.marker(new L.LatLng(lat, lon), {icon: divIcon })
		
		params.HUC.LabelLayer.addLayer(marker);
		    // Disable dragging when user's cursor enters the element
		marker.addEventListener('mouseover', function () {
			params.leafmap.dragging.disable();
			marker.dragging.enable();
		});
		
		marker.on('dragend', function(e) {
			
		});

    // Re-enable dragging when user's cursor leaves the element
		marker.addEventListener('mouseout', function () {
			params.leafmap.dragging.enable();
		});
		
		d3.selectAll(".huclabeltable").style("color",params.HUC.labelcolor)
		d3.selectAll(".huclabeltable td").style("font-size",params.HUC.labelsize)
}

function getPieIcon(pdata) {
		
        var n = pdata.values.count, //total count
        strokeWidth = 1, //Set clusterpie stroke width
		rmax = 40,
        //r = Math.pow(params.pie.scale,1.5)*Math.sqrt(n)/10,
		//r = rmax-2*strokeWidth-(n<10?30:n<50?25:n<100?20:n<), //Calculate clusterpie radius...
		r = params.pie.sliderscale*(rmax - d3.scale.threshold().domain(params.pie.scale[params.RME.aggregation_level]).range([25,20,15,10,5,2])(n));
        iconDim = (r+strokeWidth)*2 //...and divIcon dimensions (leaflet really want to know the size)

		
		var data = []
		params.RME.breaks.range().forEach(function(d){
			data.push({key: d, value: pdata.values[d][params.RME.variable]})
		})

        var html = bakePie({data: data,
                            valueFunc: function(d){return d.value;},
                            strokeWidth: 1,
                            outerRadius: r,
                            innerRadius: 1,
                            pieClass: 'pie HUC' + pdata.key,
                            pieLabel: n,
                            pieLabelClass: 'pie-label',
                            pathClassFunc: function(d){return params.pie.selectedcolor + "-" + params.RME.breaks.range().indexOf(d.data.key);},
                            //pathTitleFunc: function(d){return metadata.fields[categoryField].lookup[d.data.key]+' ('+d.data.values.length+' accident'+(d.data.values.length!=1?'s':'')+')';}
                          }),
        //Create a new divIcon and assign the svg markup to the html property
        myIcon = new L.DivIcon({
            html: html,
            className: 'marker-cluster', 
            iconSize: new L.Point(iconDim, iconDim)
        });
    return myIcon;
}

/*function that generates a svg markup for the pie chart*/
function bakePie(options) {
    /*data and valueFunc are required*/
    if (!options.data || !options.valueFunc) {
        return '';
    }
    var data = options.data,
        valueFunc = options.valueFunc,
        r = options.outerRadius?options.outerRadius:28, //Default outer radius = 28px
        rInner = options.innerRadius?options.innerRadius:r-10, //Default inner radius = r-10
        strokeWidth = options.strokeWidth?options.strokeWidth:1, //Default stroke is 1
        pathClassFunc = options.pathClassFunc?options.pathClassFunc:function(){return '';}, //Class for each path
        pathTitleFunc = options.pathTitleFunc?options.pathTitleFunc:function(){return '';}, //Title for each path
        pieClass = options.pieClass?options.pieClass:'marker-cluster-pie', //Class for the whole pie
        pieLabel = options.pieLabel?options.pieLabel:d3.sum(data,valueFunc), //Label for the whole pie
        pieLabelClass = options.pieLabelClass?options.pieLabelClass:'marker-cluster-pie-label',//Class for the pie label
        
        origo = (r+strokeWidth), //Center coordinate
        w = origo*2, //width and height of the svg element
        h = w,
        donut = d3.layout.pie().sort(function(a,b){return params.RME.range.indexOf(a.key)-params.RME.range.indexOf(b.key);}),
        arc = d3.svg.arc().innerRadius(rInner).outerRadius(r);
    //Create an svg element
    var svg = document.createElementNS(d3.ns.prefix.svg, 'svg');
    //Create the pie chart
    var vis = d3.select(svg)
        .data([data])
        .attr('class', pieClass)
        .attr('width', w)
        .attr('height', h);
        
    var arcs = vis.selectAll('g.arc')
        .data(donut.value(valueFunc))
        .enter().append('svg:g')
        .attr('class', 'arc')
        .attr('transform', 'translate(' + origo + ',' + origo + ')');
    
    arcs.append('svg:path')
        .attr('class', pathClassFunc)
        .attr('stroke-width', strokeWidth)
		//.style("fill",function(d){return d.data.color;})
		//.style("background",function(d){return d.data.color;})
		//.style("stroke",function(d){return shadeColor2(d.data.color,-0.5);})
		//.style("border-color",function(d){return shadeColor2(d.data.color,-0.5);})	
        .attr('d', arc)
        .append('svg:title')
        .text(pathTitleFunc);
		

                
    vis.append('text')
        .attr('x',origo)
        .attr('y',origo)
        .attr('class', pieLabelClass)
        .attr('text-anchor', 'middle')
        //.attr('dominant-baseline', 'central')
        /*IE doesn't seem to support dominant-baseline, but setting dy to .3em does the trick*/
        .attr('dy','.3em')
        .text(pieLabel);
    //Return the svg-markup rather than the actual element
    return serializeXmlNode(svg);
}

function serializeXmlNode(xmlNode) {
    if (typeof window.XMLSerializer != "undefined") {
        return (new window.XMLSerializer()).serializeToString(xmlNode);
    } else if (typeof xmlNode.xml != "undefined") {
        return xmlNode.xml;
    }
    return "";
}

var addPieLegend = function(){
	var legend = d3.select("#pie_legend");
	legend.selectAll("svg").remove();

	var range = params.RME.range
	var height = (range.length + 2)*17;//17 extra for top line
	var width = 75;
		
	var data = []
	var maxlength=0
	for(i=0;i<range.length;i++){
		data.push({label: range[i], color: params.pie.colors[params.pie.selectedcolor].palette[i]});
		maxlength = range[i].length > maxlength ? range[i].length : maxlength;
	}
	width = 35 + maxlength*8;
		
		var svg = legend.append("svg")
			.attr("height", height)
			.attr("width", width)	
		
		svg.append("rect")
			.attr("x",0)
			.attr("y",0)
			.attr("height", height)
			.attr("width", width)
			.style("fill","white")
			
		svg
			.append("g")
			.append("text")
			.attr("transform","translate(1,12)")
			.text("Fish/100m")
			.style("font-size",14)
			
		svg	
			.selectAll(".pielegend")
			.data(data)
			.enter()
			.append("g")
			.attr("class","pielegend")
			.attr("transform",function(d,i){
				return "translate(0," + (i*17+17) + ")";//10 extra for header
			})
		svg	
			.selectAll(".pielegend")
			.append("line")
			.attr("x1",5).attr("y1",5).attr("x2",30).attr("y2",5)
			.style("stroke",function(d){return d.color})
			.style("stroke-width",4)			
		svg	
			.selectAll(".pielegend")
			.append("text")
			.attr("transform","translate(35,10)")
			.text(function(d){return d.label})
			.style("font-size",14)
			
		svg
			.on("mouseover", function() {
			tipdiv.transition()        
				.duration(20)      
				.style("opacity", 1);      
			tipdiv.html("")
				.style("width",500)
				.style("left", (d3.event.pageX + 5) + "px")     
				.style("top", (d3.event.pageY +10) + "px");
			})                  
			.on("mouseout", function() {       
			tipdiv.transition()        
				.duration(20)      
				.style("opacity", 0);
			});		
				
}


var addPopLabel = function(id,label){
		var lat = params.population.centroids[id].Lat;
		var lon = params.population.centroids[id].Lon
		var html, words;
		html = "<table class='poplabeltable'><tr><td align='left' class='poplabel'>" + label + "</td></tr></table>"				
		var divIcon = L.divIcon({ 
		html: html,
		className: "LABEL" + id,
		draggable: true
		})
		
		var marker = L.marker(new L.LatLng(lat, lon), {icon: divIcon })
		
		params.poplabelgroup.addLayer(marker);
		    // Disable dragging when user's cursor enters the element
		marker.addEventListener('mouseover', function () {
			params.leafmap.dragging.disable();
			marker.dragging.enable();
		});
		
		marker.on('dragend', function(e) {
		var id = this.options.icon.options.className.substring(5);
		var centroid = params.population.centroids[id];
		coord = marker.getLatLng();
		centroid.Lat = [coord.lng];	
		centroid.Lon = [coord.lat];		
		});

    // Re-enable dragging when user's cursor leaves the element
		marker.addEventListener('mouseout', function () {
			params.leafmap.dragging.enable();
		});
		d3.selectAll(".poplabeltable").style("color",params.population.labelcolor)
		d3.selectAll(".poplabeltable td").style("font-size",params.population.labelsize)
}

var hucvar = d3.scale.threshold().domain([6.5,7.5,8.5]).range(["6","8","10","_12"])
	
var buildHUCStyle = function(variable){
	var fxn = function(properties,zoom){
			var hucname = "NA";
			var huc;
			huc = params.huc_lookup[properties[variable]];
			if(huc)hucname = properties[variable]
			if(hucname == "NA"){
				var style = {
								color: "green",
								opacity: 0,
								weight: 0,
								fillOpacity: 0,
								fill: "orange"
							}
				return style;			
			}
			else{
				var color = d3.scale.threshold().domain(params.RME.breaks.domain()).range(params.pie.colors[params.pie.selectedcolor].palette)
				var opacity = .8;
				var value = 0
				var style;
				switch(params.HUC.style) {
				  case "valuefill":
					style = {
						color: params.HUC.bordercolor,
						opacity: opacity,
						fillOpacity: opacity,
						fillColor: color(value),
						weight: 2,
						fill: true
					}
					break;
				  case "uniformfill":
					style = {
						color: params.HUC.bordercolor,
						opacity: opacity,
						fillOpacity: params.HUC.opacity,
						fillColor: params.HUC.color,
						weight: 2,
						fill: true
					}
					break;					
				  default:
					style = {
						color: params.HUC.bordercolor,
						opacity: opacity,
						weight: 2,
						fill: false
					}				  
				}
				return style;			
			}	
	
	}
	return fxn;
}


function addHUCLayer(){
	var Url = tileserver_url + "tileserver.php?/index.json?/HUC/{z}/{x}/{y}.pbf"
	var HUCOptions = {
		rendererFactory: L.svg.tile,
		attribution: 'NHD',
		interactive: true,
		vectorTileLayerStyles: {
			HUC3geojson: buildHUCStyle("HUC6"),
			HUC4geojson: buildHUCStyle("HUC8"),
			HUC5geojson: buildHUCStyle("HUC10"),
			HUC6geojson: buildHUCStyle("HUC_12"),
		},
		getFeatureId: function(f) {
			return "HUC" + hucvar(params.leafmap._zoom);
		}	
	};
	
	var huclayer = L.vectorGrid.protobuf(Url,HUCOptions).bindTooltip('', { sticky: true })
	params.layerControl.addOverlay(huclayer, "HUC")
	
	huclayer.on('mouseover', e => {
		L.DomEvent.stopPropagation(e)
		const attributes = e.layer.properties
		var hucid = attributes[Object.keys(attributes)[0]]
		var huc = params.huc_lookup[hucid];
		var html = 'HUC: ' + hucid + '</br>';
		if(huc){
			html += huc.name;
		}		
		huclayer.setTooltipContent(html,{ sticky:true }
		)
	})
	
	huclayer.on('click', e => {
		L.DomEvent.stopPropagation(e)
		const attributes = e.layer.properties
		var hucid = attributes[Object.keys(attributes)[0]]
		var huc = params.huc_lookup[hucid];
		if(huc){
			addHUCLabel(hucid,huc.name,{Latitude: e.latlng.lat, Longitude: e.latlng.lng })
		}
	})	
}

popstyles.styleChinook = {
		fxn: function(properties,zoom){
			var opacity = properties.NMFS_COMMO == "Chinook" ? .8 : 0
			opacity =  properties.LISTING_ST == "Threatened" | properties.LISTING_ST == "Endangered" ? opacity : 0;
			opacity =  properties.POPSTATUS == "Extant" | properties.POPSTATUS == "Reintroduction" ? opacity : 0;
			opacity =  properties.CA_POPID == "1" | properties.CA_POPID == "6" ? 0 : opacity;
			var style = {
						color: params.population.bordercolor,
						opacity: opacity,
						fillOpacity: opacity == 0 ? 0 : params.population.opacity,
						fillColor: params.population.color,
						weight: 2,
						fill: opacity == 0 ? false : true
						}
			return style;			
		},
		label: "Chinook Populations"
}

popstyles.styleSteelhead = {
		fxn: function(properties,zoom){
			var opacity = properties.NMFS_COMMO == "Steelhead" ? .8 : 0
			opacity =  properties.LISTING_ST == "Threatened" | properties.LISTING_ST == "Endangered" ? opacity : 0;
			opacity =  properties.POPSTATUS == "Extant" | properties.POPSTATUS == "Reintroduction" ? opacity : 0;
			var style = {
						color: params.population.bordercolor,
						opacity: opacity,
						fillOpacity: opacity == 0 ? 0 : params.population.opacity,
						fillColor: params.population.color,
						weight: 2,
						fill: opacity == 0 ? false : true
						}
			return style;			
		},
		label: "Steelhead Populations"
}

var addPopBoundaries = function(speciesStyle){
	console.log("adding pop boundaries")
	if(!params.poplabelgroup){
		params.poplabelgroup  = L.featureGroup()
		//params.layerControl.addOverlay(params.poplabelgroup, "Pop Labels");
	}
	params.poplabelgroup.clearLayers();
	var Url = tileserver_url + "tileserver.php?/index.json?/AllPopulations/{z}/{x}/{y}.pbf"
	var PopOptions = {
		rendererFactory: L.svg.tile,
		attribution: 'NOAA',
		interactive: true,
		vectorTileLayerStyles: {
			AllPopulationsgeojson: popstyles[speciesStyle].fxn
		},
		getFeatureId: function(f) {
			return f.properties.PopID;
		}
	};
	
	var poplayer = L.vectorGrid.protobuf(Url,PopOptions).bindTooltip('', { sticky: true })
	params.layerControl.addOverlay(poplayer, popstyles[speciesStyle].label)
	
	poplayer.on('mouseover', e => {
		L.DomEvent.stopPropagation(e)
		const attributes = e.layer.properties
		var popid = attributes.CA_POPID
		var pop = params.pops[popid];
		var popname = popid + "- NA";
		if(pop)popname = popid + " - " + pop.POPULATIONNAME.split(" - ")[0];
		var html = popname + '</br>';		
		poplayer.setTooltipContent(html,{ sticky:true }
		)
	})
	
	poplayer.on('click', e => {
		L.DomEvent.stopPropagation(e)
		const attributes = e.layer.properties
		var popid = attributes.CA_POPID
		var pop = params.pops[popid];
		var popname = "NA";
		if(pop){
			if(pop)popname = pop.POPULATIONNAME.split(" - ")[0];
			addPopLabel(popid,popname,{Latitude: e.latlng.lat, Longitude: e.latlng.lng })
		}
	})	

	var legend = d3.select("#pop_legend");
		legend.selectAll("svg").remove();
	if(popstyles[speciesStyle].legend){
		console.log(legend)
		var height = (popstyles[speciesStyle].legend.data.length)*17;
		var width = popstyles[speciesStyle].legend.width;
		var svg = legend.append("svg")
			.attr("height", height)
			.attr("width", width)
		
		svg.append("rect")
			.attr("x",0)
			.attr("y",0)
			.attr("height", height)
			.attr("width", width)
			.style("fill","white")
			
		svg	
			.selectAll(".poplegend")
			.data(popstyles[speciesStyle].legend.data)
			.enter()
			.append("g")
			.attr("class","poplegend")
			.attr("transform",function(d,i){
				return "translate(0," + (i*17+3) + ")"
			})
		svg	
			.selectAll(".poplegend")
			.append("rect")
			.attr("x",0).attr("y",0).attr("height",25).attr("width",25)
			.style("fill",function(d){return d.value})
			.style("stroke-width",4)			
		svg	
			.selectAll(".poplegend")
			.append("text")
			.attr("transform","translate(35,13)")
			.text(function(d){return d.label})
			.style("font-size",14)
		}	
}

var addPopLabel = function(id,name,location){
		var lat = location.Latitude;
		var lon = location.Longitude;
		var html, words;
		
		html = "<table class='poplabeltable'><tr><td align='left' class='poplabel'>" + name + "</td></tr></table>"
		
		var divIcon = L.divIcon({ 
		html: html,
		className: "poplabel",
		draggable: true,
		color: params.population.labelcolor
		})
		
		var marker = L.marker(new L.LatLng(lat, lon), {icon: divIcon })
		
		params.poplabelgroup.addLayer(marker);
		    // Disable dragging when user's cursor enters the element
		marker.addEventListener('mouseover', function () {
			params.leafmap.dragging.disable();
			marker.dragging.enable();
		});
		
		marker.on('dragend', function(e) {
			
		});

    // Re-enable dragging when user's cursor leaves the element
		marker.addEventListener('mouseout', function () {
			params.leafmap.dragging.enable();
		});
		
		d3.selectAll(".poplabeltable").style("color",params.population.labelcolor)
		d3.selectAll(".poplabeltable td").style("font-size",params.population.labelsize)
}

//var rivercolorfxn = d3.scale.ordinal().domain(params.RME.breaks.range()).range(params.pie.colors[params.pie.selectedcolor].palette);

var addPostRendering = function(chart,loc){
	var cname = chart.name
	var toggleAxisVariable = function(){
		var _chart = params.charts[cname];
		_chart.selected = _chart.selected < _chart.vars.length-1 ? _chart.selected+1 : 0;
		setGroup(chart,chart.name)
		//chart.group(getGroup(chart.dimension(),_chart.vars[_chart.selected].name,_chart.vars[_chart.selected].type))
	}
	var updateAxisLabel = function(){
		d3.selectAll("." + cname + "_chart")
		.text(params.charts[cname].vars[params.charts[cname].selected].text)
	}
	chart.on('postRender', function(_chart) {
		if(loc=="x"){
			_chart.svg().append('text').attr('text-anchor', 'middle')
			.attr('x', 160).attr('y', chart.height()-10)
			.text(params.charts[cname].vars[params.charts[cname].selected].text)
			.attr("class",cname + "_chart" + " axis_text")
			.on("click",function(){
				toggleAxisVariable()
				updateAxisLabel()
				_chart.redraw();
			})
			.on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('click to change')	
                .style("left", (d3.event.pageX + 5) + "px")     
                .style("top", (d3.event.pageY +10) + "px");
			})                  
			.on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);
			});			
		}
		else{
			_chart.svg().append('text').attr('class', 'yaxis-label').attr('text-anchor', 'middle')
			.attr('x', -90).attr('y', 40).attr('dy', '-25').attr('transform', 'rotate(-90)')
			.text(params.charts[cname].vars[params.charts[cname].selected].text)
			.attr("class",cname + "_chart" + " axis_text")
			.on("click",function(){
				toggleAxisVariable()
				updateAxisLabel()
				_chart.redraw();
			});
		}
		//add link for data as table
		d3.select("#" + cname + "_table")
			.on("click",function(){
				var data = chart.data();
				var c = params.charts[chart.name].vars[params.charts[chart.name].selected];
				var html = "<div class='outputwindow' style='height: 700px; overflow: auto'>";
				console.log(data);
				html += "<h4>Filters Applied</h4>"
				var filters = getChartFilters(chart,"action_charts");
				if (filters == "")html += "None"
				else html += filters
				html += "<h4>Data</h4>" + data2Table(chart,c,data);
				html += "</div>";
				var divIcon = L.divIcon({
				iconSize: new L.Point(1,1), 
				html: ''
				})
				if(params.outputmarker)params.leafmap.removeLayer(params.outputmarker);
				var bounds = params.leafmap.getBounds();
				params.outputmarker = L.marker([bounds._southWest.lat, (bounds._northEast.lng+bounds._southWest.lng)/2], {icon: divIcon })
					.addTo(params.leafmap)
					.bindPopup(html,{minWidth: 650, autopan: false}).openPopup();
				d3.selectAll(".outputwindow")
					.selectAll("table").style("border","2px solid black")
					.selectAll("td","th").style("border","1px solid black")
					
				//d3.selectAll(".outputwindow").node().appendChild(chart.svg().node().cloneNode(true))
				//d3.selectAll(".outputwindow").selectAll("svg").attr("scale",.5)
				//synchronizeCssStyles(chart.svg().node(), d3.selectAll(".outputwindow").selectAll("svg").node(),true)
			})
	});	
}

var getChartFilters = function(chart,group){
	var filters = {}
	dc.chartRegistry.list(group).forEach(function(d){
		if(d.hasFilter()){
			if(d.chartID() != chart.chartID())filters[d.displayname] = d.filters().join()
		}
	})
	if(Object.keys(filters).length>0)return obj2Table(filters,600);
	else return "";
}

var getGroup = function(dim){
	var group = dim.group().reduce(
		function (p, v) {
			p.sum += v.WSE_Budget;
			p.ovhd += Math.round(v.Overhead);
			p.sumplus += v.WSE_Budget + Math.round(v.Overhead);
			return p;
		},

		function (p, v) {
			p.sum -= v.WSE_Budget;
			p.ovhd -= Math.round(v.Overhead);
			p.sumplus -= v.WSE_Budget + Math.round(v.Overhead);
			return p;
		},

		function () {
			return {
				sum: 0,
				ovhd: 0,
				sumplus: 0
			};
		}
    );
	return group;
}	

var setGroup = function(chart,cname){
var dim = chart.dimension();
var selected = params.charts[cname].vars[params.charts[cname].selected];
var name = selected.name, type = selected.type;
var group;
switch(type) {
	case "count":
	group = dim.group().reduce(
        function (p, v) {
            if(p.elements[v[name]])p.elements[v[name]]++;
			else{
				p.elements[v[name]] = 1;
				p.n++;
			}
            return p;
        },

        function (p, v) {
			if(p.elements[v[name]]){
				p.elements[v[name]]--;
				if(p.elements[v[name]] <= 0){
					delete p.elements[v[name]];
					p.n--;
				}
			}
			return p;
        },

        function () {
            return {
				n: 0,
				elements: {}
            };
        }
    );
		break;
	case "wse":
	group = dim.group().reduce(
        function (p, v) {
            if(p.elements[v.wse_id])p.elements[v.wse_id]++;
			else{
				p.elements[v.wse_id] = 1;
				p.n += v[name];
			}
            return p;
        },

        function (p, v) {
			if(p.elements[v.wse_id]){
				p.elements[v.wse_id]--;
				if(p.elements[v.wse_id] <= 0){
					delete p.elements[v.wse_id];
					p.n -= v[name];
				}
			}
			return p;
        },

        function () {
            return {
				n: 0,
				elements: {}
            };
        }
    );
		break;		
	case "sum":
	group = dim.group().reduce(
        function (p, v) {
            p.n += +v[name];
            return p;
        },

        function (p, v) {
            p.n -= +v[name];
            return p;
        },

        function () {
            return {
				n: 0,
            };
        }
    );
		break;
	default:
	group = dim.group().reduce(
        function (p, v) {
            p.n++
            return p;
        },

        function (p, v) {
            p.n--;
            return p;
        },

        function () {
            return {
				n: 0,
            };
        }
    );
}

	params.groups.push(group)
	chart.group(group);
	chart.name = cname;
	return(chart)
}

var setChart = function(obj,dim,width,height,radius,cy,legend){
		obj
			.width(width)
			.height(height)
			.radius(radius)
			.cy(cy)	
			.dimension(dim)
			.keyAccessor(function (p) {return p.key;}).valueAccessor(function (p) {return p.value[params.accessorvar]/1000000})
			.group(getGroup(dim));
			
		if(legend){
			obj
				.cx(70)
				.minAngleForLabel(6)
				.legend(dc.legend().x(160).y(10).itemHeight(13).gap(5))	
		}
	}

var addSlider = function(chart){
	var xpos = chart.legend().x()-30;
	var initvalue = 0;
	var height = chart.height()-10;
	var ypos = 10;
	chart.legend().y(ypos);
	var svg = chart.svg();
	svg.selectAll(".slider").remove();
	chart.redraw();
	var scrollHeight = function(){
		var n = chart.data().length;
		return n*(chart.legend().itemHeight() + chart.legend().gap())-height + 10;
	}
	
	if(scrollHeight() > height){
		
		var g = svg.append("g")
				.attr("class","slider")
				.attr("transform", "translate(" + xpos + ",0)");
				
		var margin = {top: 0, right: 5, bottom: 0, left: 5},
			width = 40 - margin.left - margin.right,
			midX = width/2;
				//height = svg.attr("height") - margin.top - margin.bottom;

		var y = d3.scale.linear()
				.domain([0, 100])
				.range([10, height])
				.clamp(true);

		var brush = d3.svg.brush()
				.y(y)
				.extent([0, 0])
				.on("brush", brushed);

		var slider = g.append("g")
				.attr("transform", "translate(" + midX + ", 0)");

		slider.append("g")
				.attr("class", "y axis")
				.call(d3.svg.axis()
						.scale(y)
						.orient("right")
						.tickFormat(function(d) { return d + ""; })
						.tickSize(0)
						.tickPadding(13))
				.select(".domain")
				.select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
				.attr("class", "halo");
		svg.selectAll(".tick").remove()
		var prevVal = 0;
		var handle = slider.append("path")
				.attr("class", "handle")
				.attr("d", "M-7 -4 L-7 4 L-5 6 L5 6 L11 0 L5 -6 L-5 -6 Z")
				.attr("transform", "translate(0, " + y(prevVal) + ")");
				
		var scroll = function(value){
			var displace = -scrollHeight()*value/100 + 10
			chart.legend().y(displace);
			//console.log(value + ": " + displace)
			chart.redraw();
		}	
		
		handle.on("mousemove", function(){
			scroll(value);
		});
		

		var ruler = slider.append("g")
				.attr("transform", "translate(-4, 0)")
				.attr("class", "ruler")
				.call(brush);

		ruler.selectAll(".extent,.resize")
				.remove();

		ruler.select(".background")
				.style("cursor", "ns-resize")
				.attr("width", 40);

		// initial animation
		ruler.call(brush.event)
				.transition()
				.duration(750)
				.ease("out-in")
				.call(brush.extent([initvalue, initvalue]))
				.call(brush.event);
		
		var value;
}
	
    function brushed() {
        value = brush.extent()[1],
            t = d3;

        if (d3.event.sourceEvent) { // not a programmatic event
            value = y.invert(d3.mouse(this)[1]);
            brush.extent([value, value]);
            if (d3.event.sourceEvent.type === "mousemove") {
                // interrupt transition
                handle.interrupt();
                d3.select("body").interrupt();
            } else if (value != prevVal) {
                // animate when is't a click, not a drag
                t = d3.transition()
                        .duration(Math.abs(y(value) - y(prevVal)))
                        .ease("out-in");
            }
        }

        svg.select(".handle")
            .attr("transform", "translate(0, " + y(value) + ")");
        prevVal = value;
    }
} 

	var setFilterToggle = function(chart,id){
		var svg = chart.svg();
		d3.select("#" + id)
			.select("strong")
			.on("click",function(){
				if(svg.style("display")=="inline")svg.style("display","none")
				else {
					svg.style("display","inline")
					chart.redraw()
				}
			})
			.style("cursor","pointer")
	}
	

function uniq(a) {
    var prims = {"boolean":{}, "number":{}, "string":{}}, objs = [];

    return a.filter(function(item) {
        var type = typeof item;
        if(type in prims)
            return prims[type].hasOwnProperty(item) ? false : (prims[type][item] = true);
        else
            return objs.indexOf(item) >= 0 ? false : objs.push(item);
    });
}

function generateCSS(colorset,prefix){
	var str = ""
	colorset.forEach(function(d,i){
		str += "." + prefix + "-";
		str += i + "{";
		str += "fill: " + d + ";";
		str += "stroke: " + "#800" + ";";
		str += "background: " + d + ";";
		str += "border-color: " + "#800" + ";";
		str += "}\r\n"
	})
	return str;
}

var plotDensity = function(survived){
	var keys = []
	for(i=60;i<244;i++)keys.push(i);
	var kdata = []
	
	
	
	arrday.group().top(Infinity).forEach(function(day){
		var total = survived ? getSurvived(day) : day.value.total;
		for(j=0;j<total;j++)kdata.push(day.key)
	})

	var density = kernelDensityEstimator(kernelEpanechnikov(7), keys)(kdata);
	
	var y2 = d3.scale.linear().domain([0,.1]).range(arrday.y().range())

    var line= d3.svg.line().x(function (d) {
         return arrday.x()(new Date(2018, 0, d[0])) + arrday.margins().top;
     }).y(function (d) {
        return y2(d[1]) + arrday.margins().left;
    }).interpolate("linear")

    arrday.svg()
		.append("path")
		.attr("d",line(density))
		.style("fill","none")
		.style("stroke-width",2)
		.style("stroke",survived ? "green" : "blue")	
}

const copyToClipboard = str => {
  const el = document.createElement('textarea');
  el.value = str;
  document.body.appendChild(el);
  el.select();
  document.execCommand('copy');
  document.body.removeChild(el);
  console.log("copied to clipboard")
};

/*
function setCSV(datarows,filename){
let csvContent = "data:text/csv;charset=utf-8,";
datarows.forEach(function(rowArray){
   let row = rowArray.join(",");
   csvContent += row + "\r\n";
});

var encodedUri = encodeURI(csvContent);
var link = document.createElement("a");
link.setAttribute("href", encodedUri);
link.setAttribute("download", filename);
document.body.appendChild(link); // Required for FF
return link
}

async function writeCSV(datarows, filename){
//from https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
//const rows = [["name1", "city1", "some other info"], ["name2", "city2", "more info"]];

  try {
	var link = await setCSV(datarows,filename)
    //console.log(await response.text());
	link.click(); // This will download the data file.
  }
  catch (err) {
    console.log('fetch failed', err);
  }

}*/

var writeCSV = function(datarows, filename){
//from https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side

let csvContent = "data:text/csv;charset=utf-8,";
datarows.forEach(function(rowArray){
   let row = rowArray.join(",");
   csvContent += row + "\r\n";
});

var encodedUri = encodeURI(csvContent);
var link = document.createElement("a");
link.setAttribute("href", encodedUri);
link.setAttribute("download", filename);
document.body.appendChild(link); // Required for FF

link.click(); // This will download the data file named "my_data.csv".

}


  
function kernelDensityEstimator(kernel, X) {
  return function(V) {
    return X.map(function(x) {
      return [x, d3.mean(V, function(v) { return kernel(x - v); })];
    });
  };
}

function kernelEpanechnikov(k) {
  return function(v) {
    return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
  };
} 

var wilsonScore = function (positiveScore, total) {
//from https://github.com/msn0/wilson-score-interval
    if (total === 0) {
        return {
            left: 0,
            right: 0
        };
    }

    // phat is the proportion of successes
    // in a Bernoulli trial process
    const phat = positiveScore / total;

    // z is 1-alpha/2 percentile of a standard
    // normal distribution for error alpha=5%
    const z = 1.96;

    // implement the algorithm
    // (http://goo.gl/kgmV3g)
    const a = phat + z * z / (2 * total);
    const b = z * Math.sqrt((phat * (1 - phat) + z * z / (4 * total)) / total);
    const c = 1 + z * z / total;

    return {
        left: (a - b) / c,
        right: (a + b) / c
    };
};

var cloneSVG = function(chart,target){
	var index = d3.select("#gallery").selectAll("svg")[0].length;
	var svg = chart.svg().node().cloneNode(true)
	var text = d3.select('#clone_text').node().value
	$("#" + target).append("<h4 class='gallery" + index + "'>" + text + "</h4>")
	$("#" + target).append(svg);// append the img to the DOM
	$("#" + target).append("<br class='gallery" + index + "'/>")	
	d3.select('#clone_text').node().value = ""
	//attribute up the added
	d3.select("#gallery").selectAll("svg").each(function(d,i){
		if(i==index){
			var _svg = d3.select(this)
			_svg.attr("class","gallery" + index)
			addCloseButton(_svg,index)
		}	
	})
}

var addCloseButton = function(svg1,index){
	var width = svg1.attr("width")
	svg1
	  .append("image")
      .attr("xlink:href", "close_icon.jpg")
      .attr("x", width-22)
      .attr("y", 0)
      .attr("width", 20)
      .attr("height", 20)
	  .attr("class", "close_button")
	  .style("opacity",1)
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('Delete This')  
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 10) + "px");    
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);   
		})
	  .on("click", function(d){			
		d3.selectAll(".gallery" + index).remove();
		tipdiv.style("opacity", 0);
		});
}

var createImagePlot = function(chart,target){
	 svgString = getSVGString(chart.svg().node())
	 var imgElem = svgString2Image( svgString, chart.width(), chart.height(), 'png');
	 console.log(d3.select('#' + target))
	 $('#'+target).append(imgElem);// append the img to the DOM
	 $('#'+target).append("<br/>")
   }

// Below are the functions that handle actual exporting:
// getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
function getSVGString( svgNode ) {
	svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
	var cssStyleText = getCSSStyles( svgNode );
	appendCSS( cssStyleText, svgNode );

	var serializer = new XMLSerializer();
	var svgString = serializer.serializeToString(svgNode);
	svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
	svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

	return svgString;

	function getCSSStyles( parentElement ) {
		var selectorTextArr = [];

		// Add Parent element Id and Classes to the list
		selectorTextArr.push( '#'+parentElement.id );
		for (var c = 0; c < parentElement.classList.length; c++)
				if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
					selectorTextArr.push( '.'+parentElement.classList[c] );

		// Add Children element Ids and Classes to the list
		var nodes = parentElement.getElementsByTagName("*");
		for (var i = 0; i < nodes.length; i++) {
			var id = nodes[i].id;
			if ( !contains('#'+id, selectorTextArr) )
				selectorTextArr.push( '#'+id );

			var classes = nodes[i].classList;
			for (var c = 0; c < classes.length; c++)
				if ( !contains('.'+classes[c], selectorTextArr) )
					selectorTextArr.push( '.'+classes[c] );
		}

		// Extract CSS Rules
		var extractedCSSText = "";
		for (var i = 0; i < document.styleSheets.length; i++) {
			var s = document.styleSheets[i];
			
			try {
			    if(!s.cssRules) continue;
			} catch( e ) {
		    		if(e.name !== 'SecurityError') throw e; // for Firefox
		    		continue;
		    	}

			var cssRules = s.cssRules;
			for (var r = 0; r < cssRules.length; r++) {
				if ( contains( cssRules[r].selectorText, selectorTextArr ) )
					extractedCSSText += cssRules[r].cssText;
			}
		}
		

		return extractedCSSText;

		function contains(str,arr) {
			return arr.indexOf( str ) === -1 ? false : true;
		}

	}

	function appendCSS( cssText, element ) {
		var styleElement = document.createElement("style");
		styleElement.setAttribute("type","text/css"); 
		styleElement.innerHTML = cssText;
		var refNode = element.hasChildNodes() ? element.children[0] : null;
		element.insertBefore( styleElement, refNode );
	}
}


//function svgString2Image( svgString, width, height, format, callback ) {
function svgString2Image( svgString, width, height, format) {
	var format = format ? format : 'png';

	var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

	var canvas = document.createElement("canvas");
	var context = canvas.getContext("2d");

	canvas.width = width;
	canvas.height = height;

	var image = new Image();
	image.onload = function() {
		context.clearRect ( 0, 0, width, height );
		context.drawImage(image, 0, 0, width, height);

		canvas.toBlob( function(blob) {
			var filesize = Math.round( blob.length/1024 ) + ' KB';
			//if ( callback ) callback( blob, filesize );
		});

		
	};

	image.src = imgsrc;
	return(image)
} 

params.population.centroids =
{
  "2": {"Lon": -116.612,"Lat": 46.377},
  "3": {"Lon": -116.133,"Lat": 46.121},
  "4": {"Lon": -116.592,"Lat": 46.745},
  "5": {"Lon": -115.671,"Lat": 45.799},
  "6": {"Lon": -116.984,"Lat": 45.383},
  "7": {"Lon": -117.83,"Lat": 45.266},
  "8": {"Lon": -118.331,"Lat": 45.235},
  "9": {"Lon": -116.841,"Lat": 45.414},
  "10": {"Lon": -117.936,"Lat": 45.794},
  "11": {"Lon": -117.409,"Lat": 45.459},
  "12": {"Lon": -117.578,"Lat": 45.321},
  "13": {"Lon": -117.712,"Lat": 46.009},
  "14": {"Lon": -117.279,"Lat": 46.231},
  "15": {"Lon": -117.768,"Lat": 46.382},
  "16": {"Lon": -115.415,"Lat": 44.391},
  "17": {"Lon": -115.112,"Lat": 45.113},
  "18": {"Lon": -114.512,"Lat": 44.854},
  "19": {"Lon": -115.168,"Lat": 45.495},
  "20": {"Lon": -114.738,"Lat": 44.61},
  "21": {"Lon": -115.114,"Lat": 44.404},
  "22": {"Lon": -114.755,"Lat": 45.151},
  "23": {"Lon": -115.171,"Lat": 44.702},
  "24": {"Lon": -115.43,"Lat": 44.552},
  "25": {"Lon": -115.48,"Lat": 44.846},
  "26": {"Lon": -116.271,"Lat": 45.374},
  "27": {"Lon": -115.85,"Lat": 45.187},
  "28": {"Lon": -115.762,"Lat": 45.212},
  "29": {"Lon": -114.36,"Lat": 44.082},
  "30": {"Lon": -113.551,"Lat": 44.861},
  "31": {"Lon": -114.08,"Lat": 45.459},
  "32": {"Lon": -113.769,"Lat": 44.426},
  "33": {"Lon": -114.323,"Lat": 45.158},
  "34": {"Lon": -114.269,"Lat": 44.565},
  "35": {"Lon": -114.848,"Lat": 43.993},
  "36": {"Lon": -115.041,"Lat": 44.267},
  "37": {"Lon": -114.701,"Lat": 44.413},
  "38": {"Lon": -115.02,"Lat": 46.392},
  "39": {"Lon": -115.908,"Lat": 46.416},
  "40": {"Lon": -115.975,"Lat": 46.819},
  "41": {"Lon": -115.316,"Lat": 45.975},
  "42": {"Lon": -114.916,"Lat": 46.19},
  "43": {"Lon": -115.323,"Lat": 46.715},
  "44": {"Lon": -114.724,"Lat": 45.862},
  "45": {"Lon": -120.489,"Lat": 47.872},
  "46": {"Lon": -120.246,"Lat": 48.526},
  "47": {"Lon": -120.788,"Lat": 47.713},
  "57": {"Lon": -120.441,"Lat": 44.035},
  "58": {"Lon": -120.895,"Lat": 44.866},
  "59": {"Lon": -121.46,"Lat": 44.82},
  "60": {"Lon": -121.228,"Lat": 45.493},
  "61": {"Lon": -121.133,"Lat": 46.026},
  "62": {"Lon": -120.512,"Lat": 45.87},
  "63": {"Lon": -121.579,"Lat": 45.951},
  "64": {"Lon": -120.184,"Lat": 44.996},
  "65": {"Lon": -118.942,"Lat": 44.415},
  "66": {"Lon": -118.859,"Lat": 44.717},
  "67": {"Lon": -119.012,"Lat": 44.934},
  "68": {"Lon": -119.431,"Lat": 44.179},
  "69": {"Lon": -118.167,"Lat": 46.275},
  "70": {"Lon": -119.203,"Lat": 45.712},
  "71": {"Lon": -118.432,"Lat": 46.005},
  "72": {"Lon": -119.873,"Lat": 45.491},
  "73": {"Lon": -120.871,"Lat": 46.677},
  "74": {"Lon": -120.091,"Lat": 46.217},
  "75": {"Lon": -120.771,"Lat": 46.367},
  "76": {"Lon": -120.738,"Lat": 47.094},
  "77": {"Lon": -116.356,"Lat": 46.39},
  "78": {"Lon": -114.962,"Lat": 46.412},
  "79": {"Lon": -115.794,"Lat": 46.34},
  "80": {"Lon": -115.584,"Lat": 46.757},
  "81": {"Lon": -114.914,"Lat": 45.981},
  "82": {"Lon": -115.664,"Lat": 45.796},
  "83": {"Lon": -117.522,"Lat": 45.923},
  "84": {"Lon": -118.085,"Lat": 45.343},
  "85": {"Lon": -117.092,"Lat": 45.747},
  "86": {"Lon": -117.451,"Lat": 45.425},
  "87": {"Lon": -116.641,"Lat": 45.669},
  "89": {"Lon": -116.899,"Lat": 45.402},
  "90": {"Lon": -117.229,"Lat": 46.348},
  "91": {"Lon": -117.95,"Lat": 46.525},
  "92": {"Lon": -114.813,"Lat": 44.938},
  "93": {"Lon": -115.503,"Lat": 45.462},
  "94": {"Lon": -114.282,"Lat": 44.323},
  "95": {"Lon": -113.551,"Lat": 44.861},
  "96": {"Lon": -116.349,"Lat": 45.553},
  "97": {"Lon": -115.19,"Lat": 44.607},
  "98": {"Lon": -114.08,"Lat": 45.459},
  "99": {"Lon": -113.856,"Lat": 44.616},
  "100": {"Lon": -114.467,"Lat": 45.246},
  "101": {"Lon": -114.765,"Lat": 44.203},
  "102": {"Lon": -115.85,"Lat": 45.187},
  "103": {"Lon": -115.582,"Lat": 44.908},
  "104": {"Lon": -119.248,"Lat": 47.021},
  "105": {"Lon": -120.444,"Lat": 47.825},
  "106": {"Lon": -120.223,"Lat": 48.487},
  "107": {"Lon": -119.51,"Lat": 49.332},
  "108": {"Lon": -120.516,"Lat": 47.509},
  "293": {"Lon": -121.746,"Lat": 46.378},
  "294": {"Lon": -122.696,"Lat": 46.149},
  "295": {"Lon": -122.433,"Lat": 45.825},
  "296": {"Lon": -122.433,"Lat": 45.825},
  "297": {"Lon": -122.558,"Lat": 46.074},
  "298": {"Lon": -122.558,"Lat": 46.074},
  "299": {"Lon": -122.842,"Lat": 46.402},
  "300": {"Lon": -122.123,"Lat": 46.068},
  "301": {"Lon": -122.123,"Lat": 46.068},
  "302": {"Lon": -122.439,"Lat": 46.329},
  "303": {"Lon": -122.599,"Lat": 45.721},
  "304": {"Lon": -121.986,"Lat": 45.383},
  "305": {"Lon": -122.483,"Lat": 46.239},
  "306": {"Lon": -122.314,"Lat": 46.604},
  "307": {"Lon": -121.847,"Lat": 46.597},
  "308": {"Lon": -122.293,"Lat": 45.675},
  "309": {"Lon": -122.293,"Lat": 45.675},
  "310": {"Lon": -121.638,"Lat": 45.51},
  "311": {"Lon": -121.638,"Lat": 45.51},
  "312": {"Lon": -122.065,"Lat": 45.596},
  "313": {"Lon": -121.822,"Lat": 45.816},
  "314": {"Lon": -121.905,"Lat": 45.866},
  "315": {"Lon": -122.193,"Lat": 45.191},
  "316": {"Lon": -122.877,"Lat": 44.399},
  "317": {"Lon": -122.622,"Lat": 45.051},
  "318": {"Lon": -122.231,"Lat": 44.715},
  "319": {"Lon": -122.523,"Lat": 44.518},
  "346": {"Lon": -118.953,"Lat": 48.282},
  "347": {"Lon": -118.271,"Lat": 48.538},
  "348": {"Lon": -117.543,"Lat": 49.061},
  "349": {"Lon": -117.773,"Lat": 49.72},
  "350": {"Lon": -117.755,"Lat": 47.882},
  "351": {"Lon": -117.153,"Lat": 47.378},
  "352": {"Lon": -117.448,"Lat": 44.901},
  "353": {"Lon": -117.728,"Lat": 44.53},
  "354": {"Lon": -116.669,"Lat": 44.531},
  "355": {"Lon": -116.494,"Lat": 44.105},
  "356": {"Lon": -116.049,"Lat": 44.518},
  "357": {"Lon": -115.604,"Lat": 44.206},
  "358": {"Lon": -115.787,"Lat": 43.672},
  "359": {"Lon": -117.632,"Lat": 44.022},
  "360": {"Lon": -118.363,"Lat": 43.758},
  "361": {"Lon": -117.464,"Lat": 42.961},
  "362": {"Lon": -116.602,"Lat": 41.985},
  "363": {"Lon": -116.044,"Lat": 42.649},
  "364": {"Lon": -115.479,"Lat": 43.137},
  "365": {"Lon": -114.871,"Lat": 42.286},
  "366": {"Lon": -117.044,"Lat": 44.961},
  "367": {"Lon": -116.681,"Lat": 44.965},
  "368": {"Lon": -117.273,"Lat": 44.902},
  "369": {"Lon": -117.812,"Lat": 44.864},
  "370": {"Lon": -117.851,"Lat": 44.528},
  "371": {"Lon": -116.674,"Lat": 44.347},
  "372": {"Lon": -116.628,"Lat": 44.542},
  "373": {"Lon": -116.463,"Lat": 44.793},
  "374": {"Lon": -116.617,"Lat": 44.107},
  "375": {"Lon": -116.405,"Lat": 44.092},
  "376": {"Lon": -115.694,"Lat": 44.161},
  "377": {"Lon": -116.011,"Lat": 44.687},
  "378": {"Lon": -115.787,"Lat": 43.672},
  "379": {"Lon": -117.633,"Lat": 44.113},
  "380": {"Lon": -117.966,"Lat": 43.909},
  "381": {"Lon": -118.396,"Lat": 43.67},
  "382": {"Lon": -117.501,"Lat": 42.995},
  "383": {"Lon": -117.115,"Lat": 42.16},
  "384": {"Lon": -116.388,"Lat": 41.654},
  "385": {"Lon": -116.324,"Lat": 42.188},
  "386": {"Lon": -115.966,"Lat": 43.072},
  "387": {"Lon": -115.67,"Lat": 42.495},
  "388": {"Lon": -115.636,"Lat": 42.063},
  "389": {"Lon": -114.796,"Lat": 42.029},
  "390": {"Lon": -114.476,"Lat": 42.436},
  "393": {"Lon": -118.797,"Lat": 48.432},
  "394": {"Lon": -118.271,"Lat": 48.538},
  "395": {"Lon": -117.684,"Lat": 49.618},
  "396": {"Lon": -117.755,"Lat": 47.882},
  "397": {"Lon": -117.153,"Lat": 47.378},
  "398": {"Lon": -119.5,"Lat": 49.365}
}

	
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18774702-1', 'auto');
  ga('send', 'pageview');

</script>
</html>